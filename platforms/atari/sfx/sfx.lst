mads 1.9.6 build 89 (3 Apr 13)
Source: sfx.a65
     1 				;
     2 				; SFX
     3 				; example by raster/c.p.u., 2006,2009
     4 				;
     5 				;
     6 = 0000			STEREOMODE	equ 0				;0 => compile RMTplayer for mono 4 tracks
     7 				;								;1 => compile RMTplayer for stereo 8 tracks
     8 				;								;2 => compile RMTplayer for 4 tracks stereo L1 R2 R3 L4
     9 				;								;3 => compile RMTplayer for 4 tracks stereo L1 L2 R3 R4
    10 				;
    11 				;
    12 					icl "addresses.a65"			;include addresses
Source: addresses.a65
     1 = 8400			PLAYER    equ $8400
     2 = 8770			MODUL     equ $8770
     3 = AA50			SFX_CODE  equ $AA50
    13 					icl "rmtplayr.a65"			;include RMT player routine
Source: rmtplayr.a65
     1 				;*
     2 				;* Raster Music Tracker, RMT Atari routine version 1.20090108
     3 				;* (c) Radek Sterba, Raster/C.P.U., 2002 - 2009
     4 				;* http://raster.atari.org
     5 				;*
     6 				;* Warnings:
     7 				;*
     8 				;* 1. RMT player routine needs 19 itself reserved bytes in zero page (no accessed
     9 				;*    from any other routines) as well as cca 1KB of memory before the "PLAYER"
    10 				;*    address for frequency tables and functionary variables. It's:
    11 				;*	  a) from PLAYER-$03c0 to PLAYER for stereo RMTplayer
    12 				;*    b) from PLAYER-$0320 to PLAYER for mono RMTplayer
    13 				;*
    14 				;* 2. RMT player routine MUST (!!!) be compiled from the begin of the memory page.
    15 				;*    i.e. "PLAYER" address can be $..00 only!
    16 				;*
    17 				;* 3. Because of RMTplayer provides a lot of effects, it spent a lot of CPU time.
    18 				;*
    19 				;* STEREOMODE	equ 0..3			;0 => compile RMTplayer for 4 tracks mono
    20 				;*									;1 => compile RMTplayer for 8 tracks stereo
    21 				;*									;2 => compile RMTplayer for 4 tracks stereo L1 R2 R3 L4
    22 				;*									;3 => compile RMTplayer for 4 tracks stereo L1 L2 R3 R4
    23 				;*
    24 					IFT STEREOMODE==1
    25 				TRACKS		equ 8
    26 					ELS
    27 = 0004			TRACKS		equ 4
    28 					EIF
    29 				;*
    30
    31 				;*
    32 				;* RMT FEATures definitions file
    33 				;* For optimizations of RMT player routine to concrete RMT modul only!
    34 					icl "rmt_feat.a65"
Source: rmt_feat.a65
     1 				;* --------BEGIN--------
     2 				;* D:\Projekty\AdamIsMe\platforms\atari\sfx\sfx.rmt
     3 = 0001			FEAT_SFX		equ 1
     4 = 0001			FEAT_GLOBALVOLUMEFADE	equ 1		;RMTGLOBALVOLUMEFADE variable
     5 = 0000			FEAT_NOSTARTINGSONGLINE	equ 0
     6 = 0001			FEAT_INSTRSPEED		equ 1
     7 = 0000			FEAT_CONSTANTSPEED		equ 0		;(30 times)
     8 = 0001			FEAT_COMMAND1		equ 1		;(199 times)
     9 = 0001			FEAT_COMMAND2		equ 1		;(26 times)
    10 = 0000			FEAT_COMMAND3		equ 0		;(0 times)
    11 = 0000			FEAT_COMMAND4		equ 0		;(0 times)
    12 = 0000			FEAT_COMMAND5		equ 0		;(0 times)
    13 = 0000			FEAT_COMMAND6		equ 0		;(0 times)
    14 = 0000			FEAT_COMMAND7SETNOTE		equ 0		;(0 times)
    15 = 0000			FEAT_COMMAND7VOLUMEONLY		equ 0		;(0 times)
    16 = 0000			FEAT_PORTAMENTO		equ 0		;(0 times)
    17 = 0000			FEAT_FILTER		equ 0		;(0 times)
    18 = 0000			FEAT_FILTERG0L		equ 0		;(0 times)
    19 = 0000			FEAT_FILTERG1L		equ 0		;(0 times)
    20 = 0000			FEAT_FILTERG0R		equ 0		;(0 times)
    21 = 0000			FEAT_FILTERG1R		equ 0		;(0 times)
    22 = 0000			FEAT_BASS16		equ 0		;(0 times)
    23 = 0000			FEAT_BASS16G1L		equ 0		;(0 times)
    24 = 0000			FEAT_BASS16G3L		equ 0		;(0 times)
    25 = 0000			FEAT_BASS16G1R		equ 0		;(0 times)
    26 = 0000			FEAT_BASS16G3R		equ 0		;(0 times)
    27 = 0000			FEAT_VOLUMEONLYG0L		equ 0		;(0 times)
    28 = 0000			FEAT_VOLUMEONLYG2L		equ 0		;(0 times)
    29 = 0000			FEAT_VOLUMEONLYG3L		equ 0		;(0 times)
    30 = 0000			FEAT_VOLUMEONLYG0R		equ 0		;(0 times)
    31 = 0000			FEAT_VOLUMEONLYG2R		equ 0		;(0 times)
    32 = 0000			FEAT_VOLUMEONLYG3R		equ 0		;(0 times)
    33 = 0000			FEAT_TABLETYPE		equ 0		;(0 times)
    34 = 0000			FEAT_TABLEMODE		equ 0		;(0 times)
    35 = 0001			FEAT_TABLEGO		equ 1		;(5 times)
    36 = 0000			FEAT_AUDCTLMANUALSET		equ 0		;(0 times)
    37 = 0001			FEAT_VOLUMEMIN		equ 1		;(6 times)
    38 = 0001			FEAT_EFFECTVIBRATO		equ 1		;(7 times)
    39 = 0001			FEAT_EFFECTFSHIFT		equ 1		;(1 times)
    40 				;* --------END--------
    35 				;*
    36 				;* RMT ZeroPage addresses
    37 					org 203
    38 				p_tis
    39 				p_instrstable	org *+2
    40 				p_trackslbstable	org *+2
    41 				p_trackshbstable	org *+2
    42 				p_song			org *+2
    43 				ns				org *+2
    44 				nr				org *+2
    45 				nt				org *+2
    46 				reg1			org *+1
    47 				reg2			org *+1
    48 				reg3			org *+1
    49 				tmp				org *+1
    50 					IFT FEAT_COMMAND2
    51 				frqaddcmd2		org *+1
    52 					EIF
    53 					IFT TRACKS>4
    54 					org PLAYER-$400+$40
    55 					ELS
    56 					org PLAYER-$400+$e0
    57 					EIF
    58 				track_variables
    59 				trackn_db	org *+TRACKS
    60 				trackn_hb	org *+TRACKS
    61 				trackn_idx	org *+TRACKS
    62 				trackn_pause	org *+TRACKS
    63 				trackn_note	org *+TRACKS
    64 				trackn_volume	org *+TRACKS
    65 				trackn_distor 	org *+TRACKS
    66 				trackn_shiftfrq	org *+TRACKS
    67 					IFT FEAT_PORTAMENTO
    68 				trackn_portafrqc org *+TRACKS
    69 				trackn_portafrqa org *+TRACKS
    70 				trackn_portaspeed org *+TRACKS
    71 				trackn_portaspeeda org *+TRACKS
    72 				trackn_portadepth org *+TRACKS
    73 					EIF
    74 				trackn_instrx2	org *+TRACKS
    75 				trackn_instrdb	org *+TRACKS
    76 				trackn_instrhb	org *+TRACKS
    77 				trackn_instridx	org *+TRACKS
    78 				trackn_instrlen	org *+TRACKS
    79 				trackn_instrlop	org *+TRACKS
    80 				trackn_instrreachend	org *+TRACKS
    81 				trackn_volumeslidedepth org *+TRACKS
    82 				trackn_volumeslidevalue org *+TRACKS
    83 					IFT FEAT_VOLUMEMIN
    84 				trackn_volumemin		org *+TRACKS
    85 					EIF
    86 = 0001			FEAT_EFFECTS equ FEAT_EFFECTVIBRATO||FEAT_EFFECTFSHIFT
    87 					IFT FEAT_EFFECTS
    88 				trackn_effdelay			org *+TRACKS
    89 					EIF
    90 					IFT FEAT_EFFECTVIBRATO
    91 				trackn_effvibratoa		org *+TRACKS
    92 					EIF
    93 					IFT FEAT_EFFECTFSHIFT
    94 				trackn_effshift		org *+TRACKS
    95 					EIF
    96 				trackn_tabletypespeed org *+TRACKS
    97 					IFT FEAT_TABLEMODE
    98 				trackn_tablemode	org *+TRACKS
    99 					EIF
   100 				trackn_tablenote	org *+TRACKS
   101 				trackn_tablea		org *+TRACKS
   102 				trackn_tableend		org *+TRACKS
   103 					IFT FEAT_TABLEGO
   104 				trackn_tablelop		org *+TRACKS
   105 					EIF
   106 				trackn_tablespeeda	org *+TRACKS
   107 					IFT FEAT_FILTER||FEAT_BASS16
   108 				trackn_command		org *+TRACKS
   109 					EIF
   110 					IFT FEAT_BASS16
   111 				trackn_outnote		org *+TRACKS
   112 					EIF
   113 					IFT FEAT_FILTER
   114 				trackn_filter		org *+TRACKS
   115 					EIF
   116 				trackn_audf	org *+TRACKS
   117 				trackn_audc	org *+TRACKS
   118 					IFT FEAT_AUDCTLMANUALSET
   119 				trackn_audctl	org *+TRACKS
   120 					EIF
   121 				v_aspeed		org *+1
   122 				track_endvariables
   123 						org PLAYER-$100-$140-$40+2
   124 = 000C			INSTRPAR	equ 12
   125 				tabbeganddistor
   126 FFFF> 8182-81BF> 80 00	 dta frqtabpure-frqtab,$00
   127 8184 80 20		 dta frqtabpure-frqtab,$20
   128 8186 80 40		 dta frqtabpure-frqtab,$40
   129 8188 00 C0		 dta frqtabbass1-frqtab,$c0
   130 818A 80 80		 dta frqtabpure-frqtab,$80
   131 818C 80 A0		 dta frqtabpure-frqtab,$a0
   132 818E 00 C0		 dta frqtabbass1-frqtab,$c0
   133 8190 40 C0		 dta frqtabbass2-frqtab,$c0
   134 						IFT FEAT_EFFECTVIBRATO
   135 8192 00 01 05 0B		vibtabbeg dta 0,vib1-vib0,vib2-vib0,vib3-vib0
   136 8196 00			vib0	dta 0
   137 8197 01 FF FF 01		vib1	dta 1,-1,-1,1
   138 819B 01 00 FF FF 00 01	vib2	dta 1,0,-1,-1,0,1
   139 81A1 01 01 00 FF FF FF + vib3	dta 1,1,0,-1,-1,-1,-1,0,1,1
   140 81AB			vibtabnext
   141 81AB 00					dta vib0-vib0+0
   142 81AC 02 03 04 01				dta vib1-vib0+1,vib1-vib0+2,vib1-vib0+3,vib1-vib0+0
   143 81B0 06 07 08 09 0A 05			dta vib2-vib0+1,vib2-vib0+2,vib2-vib0+3,vib2-vib0+4,vib2-vib0+5,vib2-vib0+0
   144 81B6 0C 0D 0E 0F 10 11 + 		dta vib3-vib0+1,vib3-vib0+2,vib3-vib0+3,vib3-vib0+4,vib3-vib0+5,vib3-vib0+6,vib3-vib0+7,vib3-vib0+8,vib3-vib0+9,vib3-vib0+0
   145 						EIF
   146 81C0					org PLAYER-$100-$140
   147 					IFT FEAT_BASS16
   148 				frqtabbasslo
   149 					dta $F2,$33,$96,$E2,$38,$8C,$00,$6A,$E8,$6A,$EF,$80,$08,$AE,$46,$E6
   150 					dta $95,$41,$F6,$B0,$6E,$30,$F6,$BB,$84,$52,$22,$F4,$C8,$A0,$7A,$55
   151 					dta $34,$14,$F5,$D8,$BD,$A4,$8D,$77,$60,$4E,$38,$27,$15,$06,$F7,$E8
   152 					dta $DB,$CF,$C3,$B8,$AC,$A2,$9A,$90,$88,$7F,$78,$70,$6A,$64,$5E,$00
   153 					EIF
   154 81C0					org PLAYER-$100-$100
   155 8200			frqtab
   156 					ERT [<frqtab]!=0	;* frqtab must begin at the memory page bound! (i.e. $..00 address)
   157 8200			frqtabbass1
   158 8200-82BF> BF B6 AA A1 + 	dta $BF,$B6,$AA,$A1,$98,$8F,$89,$80,$F2,$E6,$DA,$CE,$BF,$B6,$AA,$A1
   159 8210 98 8F 89 80 7A 71 + 	dta $98,$8F,$89,$80,$7A,$71,$6B,$65,$5F,$5C,$56,$50,$4D,$47,$44,$3E
   160 8220 3C 38 35 32 2F 2D + 	dta $3C,$38,$35,$32,$2F,$2D,$2A,$28,$25,$23,$21,$1F,$1D,$1C,$1A,$18
   161 8230 17 16 14 13 12 11 + 	dta $17,$16,$14,$13,$12,$11,$10,$0F,$0E,$0D,$0C,$0B,$0A,$09,$08,$07
   162 8240			frqtabbass2
   163 8240 FF F1 E4 D8 CA C0 + 	dta $FF,$F1,$E4,$D8,$CA,$C0,$B5,$AB,$A2,$99,$8E,$87,$7F,$79,$73,$70
   164 8250 66 61 5A 55 52 4B + 	dta $66,$61,$5A,$55,$52,$4B,$48,$43,$3F,$3C,$39,$37,$33,$30,$2D,$2A
   165 8260 28 25 24 21 1F 1E + 	dta $28,$25,$24,$21,$1F,$1E,$1C,$1B,$19,$17,$16,$15,$13,$12,$11,$10
   166 8270 0F 0E 0D 0C 0B 0A + 	dta $0F,$0E,$0D,$0C,$0B,$0A,$09,$08,$07,$06,$05,$04,$03,$02,$01,$00
   167 8280			frqtabpure
   168 8280 F3 E6 D9 CC C1 B5 + 	dta $F3,$E6,$D9,$CC,$C1,$B5,$AD,$A2,$99,$90,$88,$80,$79,$72,$6C,$66
   169 8290 60 5B 55 51 4C 48 + 	dta $60,$5B,$55,$51,$4C,$48,$44,$40,$3C,$39,$35,$32,$2F,$2D,$2A,$28
   170 82A0 25 23 21 1F 1D 1C + 	dta $25,$23,$21,$1F,$1D,$1C,$1A,$18,$17,$16,$14,$13,$12,$11,$10,$0F
   171 82B0 0E 0D 0C 0B 0A 09 + 	dta $0E,$0D,$0C,$0B,$0A,$09,$08,$07,$06,$05,$04,$03,$02,$01,$00,$00
   172 					IFT FEAT_BASS16
   173 				frqtabbasshi
   174 					dta $0D,$0D,$0C,$0B,$0B,$0A,$0A,$09,$08,$08,$07,$07,$07,$06,$06,$05
   175 					dta $05,$05,$04,$04,$04,$04,$03,$03,$03,$03,$03,$02,$02,$02,$02,$02
   176 					dta $02,$02,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$00,$00
   177 					dta $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
   178 					EIF
   179 82C0					org PLAYER-$0100
   180 8300			volumetab
   181 8300-876C> 00 00 00 00 + 	dta $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
   182 8310 00 00 00 00 00 00 + 	dta $00,$00,$00,$00,$00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01
   183 8320 00 00 00 00 01 01 + 	dta $00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$02,$02,$02,$02
   184 8330 00 00 00 01 01 01 + 	dta $00,$00,$00,$01,$01,$01,$01,$01,$02,$02,$02,$02,$02,$03,$03,$03
   185 8340 00 00 01 01 01 01 + 	dta $00,$00,$01,$01,$01,$01,$02,$02,$02,$02,$03,$03,$03,$03,$04,$04
   186 8350 00 00 01 01 01 02 + 	dta $00,$00,$01,$01,$01,$02,$02,$02,$03,$03,$03,$04,$04,$04,$05,$05
   187 8360 00 00 01 01 02 02 + 	dta $00,$00,$01,$01,$02,$02,$02,$03,$03,$04,$04,$04,$05,$05,$06,$06
   188 8370 00 00 01 01 02 02 + 	dta $00,$00,$01,$01,$02,$02,$03,$03,$04,$04,$05,$05,$06,$06,$07,$07
   189 8380 00 01 01 02 02 03 + 	dta $00,$01,$01,$02,$02,$03,$03,$04,$04,$05,$05,$06,$06,$07,$07,$08
   190 8390 00 01 01 02 02 03 + 	dta $00,$01,$01,$02,$02,$03,$04,$04,$05,$05,$06,$07,$07,$08,$08,$09
   191 83A0 00 01 01 02 03 03 + 	dta $00,$01,$01,$02,$03,$03,$04,$05,$05,$06,$07,$07,$08,$09,$09,$0A
   192 83B0 00 01 01 02 03 04 + 	dta $00,$01,$01,$02,$03,$04,$04,$05,$06,$07,$07,$08,$09,$0A,$0A,$0B
   193 83C0 00 01 02 02 03 04 + 	dta $00,$01,$02,$02,$03,$04,$05,$06,$06,$07,$08,$09,$0A,$0A,$0B,$0C
   194 83D0 00 01 02 03 03 04 + 	dta $00,$01,$02,$03,$03,$04,$05,$06,$07,$08,$09,$0A,$0A,$0B,$0C,$0D
   195 83E0 00 01 02 03 04 05 + 	dta $00,$01,$02,$03,$04,$05,$06,$07,$07,$08,$09,$0A,$0B,$0C,$0D,$0E
   196 83F0 00 01 02 03 04 05 + 	dta $00,$01,$02,$03,$04,$05,$06,$07,$08,$09,$0A,$0B,$0C,$0D,$0E,$0F
   197 8400				org PLAYER
   198 				;*
   199 				;* Set of RMT main vectors:
   200 				;*
   201 8400			RASTERMUSICTRACKER
   202 8400 4C 12 84			jmp rmt_init
   203 8403 4C E9 85			jmp rmt_play
   204 8406 4C 03 86			jmp rmt_p3
   205 8409 4C 52 84			jmp rmt_silence
   206 840C 4C 37 87			jmp SetPokey
   207 					IFT FEAT_SFX
   208 840F 4C 6C 85			jmp rmt_sfx			;* A=note(0,..,60),X=channel(0,..,3 or 0,..,7),Y=instrument*2(0,2,4,..,126)
   209 					EIF
   210 8412			rmt_init
   211 8412 86 D3			stx ns
   212 8414 84 D4			sty ns+1
   213 					IFT FEAT_NOSTARTINGSONGLINE==0
   214 8416 48				pha
   215 					EIF
   216 					IFT track_endvariables-track_variables>255
   217 					ldy #0
   218 					tya
   219 				ri0	sta track_variables,y
   220 					sta track_endvariables-$100,y
   221 					iny
   222 					bne ri0
   223 					ELS
   224 8417 A0 75			ldy #track_endvariables-track_variables
   225 8419 A9 00			lda #0
   226 841B 99 DF 80		ri0	sta track_variables-1,y
   227 841E 88				dey
   228 841F D0 FA			bne ri0
   229 					EIF
   230 8421 A0 04			ldy #4
   231 8423 B1 D3			lda (ns),y
   232 8425 8D F7 85			sta v_maxtracklen
   233 8428 C8				iny
   234 					IFT FEAT_CONSTANTSPEED==0
   235 8429 B1 D3			lda (ns),y
   236 842B 8D B8 84			sta v_speed
   237 					EIF
   238 					IFT FEAT_INSTRSPEED==0
   239 					iny
   240 					lda (ns),y
   241 					sta v_instrspeed
   242 					sta v_ainstrspeed
   243 					ELI FEAT_INSTRSPEED>1
   244 					lda #FEAT_INSTRSPEED
   245 					sta v_ainstrspeed
   246 					EIF
   247 842E A0 08			ldy #8
   248 8430 B1 D3		ri1	lda (ns),y
   249 8432 99 C3 00			sta p_tis-8,y
   250 8435 C8				iny
   251 8436 C0 10			cpy #8+8
   252 8438 D0 F6			bne ri1
   253 					IFT FEAT_NOSTARTINGSONGLINE==0
   254 843A 68				pla
   255 843B 48				pha
   256 					IFT TRACKS>4
   257 					asl @
   258 					asl @
   259 					asl @
   260 					clc
   261 					adc p_song
   262 					sta p_song
   263 					pla
   264 					php
   265 					and #$e0
   266 					asl @
   267 					rol @
   268 					rol @
   269 					rol @
   270 					ELS
   271 843C 0A				asl @
   272 843D 0A				asl @
   273 843E 18				clc
   274 843F 65 D1			adc p_song
   275 8441 85 D1			sta p_song
   276 8443 68				pla
   277 8444 08				php
   278 8445 29 C0			and #$c0
   279 8447 0A				asl @
   280 8448 2A				rol @
   281 8449 2A				rol @
   282 					EIF
   283 844A 28				plp
   284 844B 65 D2			adc p_song+1
   285 844D 85 D2			sta p_song+1
   286 					EIF
   287 844F 20 67 84			jsr GetSongLineTrackLineInitOfNewSetInstrumentsOnlyRmtp3
   288 8452			rmt_silence
   289 					IFT STEREOMODE>0
   290 					lda #0
   291 					sta $d208
   292 					sta $d218
   293 					ldy #3
   294 					sty $d20f
   295 					sty $d21f
   296 					ldy #8
   297 				si1	sta $d200,y
   298 					sta $d210,y
   299 					dey
   300 					bpl si1
   301 					ELS
   302 8452 A9 00			lda #0
   303 8454 8D 08 D2			sta $d208
   304 8457 A0 03			ldy #3
   305 8459 8C 0F D2			sty $d20f
   306 845C A0 08			ldy #8
   307 845E 99 00 D2		si1	sta $d200,y
   308 8461 88				dey
   309 8462 10 FA			bpl si1
   310 					EIF
   311 					IFT FEAT_INSTRSPEED==0
   312 					lda v_instrspeed
   313 					ELS
   314 8464 A9 01			lda #FEAT_INSTRSPEED
   315 					EIF
   316 8466 60				rts
   317 8467			GetSongLineTrackLineInitOfNewSetInstrumentsOnlyRmtp3
   318 8467			GetSongLine
   319 8467 A2 00			ldx #0
   320 8469 8E F5 85			stx v_abeat
   321 846C			nn0
   322 846C 8A			nn1	txa
   323 846D A8				tay
   324 846E B1 D1			lda (p_song),y
   325 8470 C9 FE			cmp #$fe
   326 8472 B0 2D			bcs nn2
   327 8474 A8				tay
   328 8475 B1 CD			lda (p_trackslbstable),y
   329 8477 9D E0 80			sta trackn_db,x
   330 847A B1 CF			lda (p_trackshbstable),y
   331 847C 9D E4 80		nn1a sta trackn_hb,x
   332 847F A9 00			lda #0
   333 8481 9D E8 80			sta trackn_idx,x
   334 8484 A9 01			lda #1
   335 8486 9D EC 80		nn1a2 sta trackn_pause,x
   336 8489 A9 80			lda #$80
   337 848B 9D 00 81			sta trackn_instrx2,x
   338 848E E8				inx
   339 848F E0 04		xtracks01	cpx #TRACKS
   340 8491 D0 D9			bne nn1
   341 8493 A5 D1			lda p_song
   342 8495 18				clc
   343 8496 69 04		xtracks02	adc #TRACKS
   344 8498 85 D1			sta p_song
   345 849A 90 1B			bcc GetTrackLine
   346 849C E6 D2			inc p_song+1
   347 849E			nn1b
   348 849E 4C B7 84			jmp GetTrackLine
   349 84A1			nn2
   350 84A1 F0 04			beq nn3
   351 84A3			nn2a
   352 84A3 A9 00			lda #0
   353 84A5 F0 DF			beq nn1a2
   354 84A7			nn3
   355 84A7 A0 02			ldy #2
   356 84A9 B1 D1			lda (p_song),y
   357 84AB AA				tax
   358 84AC C8				iny
   359 84AD B1 D1			lda (p_song),y
   360 84AF 85 D2			sta p_song+1
   361 84B1 86 D1			stx p_song
   362 84B3 A2 00			ldx #0
   363 84B5 F0 B5			beq nn0
   364 84B7			GetTrackLine
   365 84B7			oo0
   366 84B7			oo0a
   367 					IFT FEAT_CONSTANTSPEED==0
   368 84B7 A9 FF			lda #$ff
   369 = 84B8			v_speed equ *-1
   370 84B9 8D 12 85			sta v_bspeed
   371 					EIF
   372 84BC A2 FF			ldx #-1
   373 84BE			oo1
   374 84BE E8				inx
   375 84BF DE EC 80			dec trackn_pause,x
   376 84C2 D0 49			bne oo1x
   377 84C4			oo1b
   378 84C4 BD E0 80			lda trackn_db,x
   379 84C7 85 D3			sta ns
   380 84C9 BD E4 80			lda trackn_hb,x
   381 84CC 85 D4			sta ns+1
   382 84CE			oo1i
   383 84CE BC E8 80			ldy trackn_idx,x
   384 84D1 FE E8 80			inc trackn_idx,x
   385 84D4 B1 D3			lda (ns),y
   386 84D6 85 D9			sta reg1
   387 84D8 29 3F			and #$3f
   388 84DA C9 3D			cmp #61
   389 84DC F0 0E			beq oo1a
   390 84DE B0 3C			bcs oo2
   391 84E0 9D F0 80			sta trackn_note,x
   392 					IFT FEAT_BASS16
   393 					sta trackn_outnote,x
   394 					EIF
   395 84E3 C8				iny
   396 84E4 B1 D3			lda (ns),y
   397 84E6 4A				lsr @
   398 84E7 29 7E			and #$3f*2
   399 84E9 9D 00 81			sta trackn_instrx2,x
   400 84EC			oo1a
   401 84EC A9 01			lda #1
   402 84EE 9D EC 80			sta trackn_pause,x
   403 84F1 BC E8 80			ldy trackn_idx,x
   404 84F4 FE E8 80			inc trackn_idx,x
   405 84F7 B1 D3			lda (ns),y
   406 84F9 4A				lsr @
   407 84FA 66 D9			ror reg1
   408 84FC 4A				lsr @
   409 84FD 66 D9			ror reg1
   410 84FF A5 D9			lda reg1
   411 					IFT FEAT_GLOBALVOLUMEFADE
   412 8501 38				sec
   413 8502 E9 00			sbc #$00
   414 = 8503			RMTGLOBALVOLUMEFADE equ *-1
   415 8504 B0 02			bcs voig
   416 8506 A9 00			lda #0
   417 8508			voig
   418 					EIF
   419 8508 29 F0			and #$f0
   420 850A 9D F4 80			sta trackn_volume,x
   421 850D			oo1x
   422 850D E0 03		xtracks03sub1	cpx #TRACKS-1
   423 850F D0 AD			bne oo1
   424 					IFT FEAT_CONSTANTSPEED==0
   425 8511 A9 FF			lda #$ff
   426 = 8512			v_bspeed equ *-1
   427 8513 8D B8 84			sta v_speed
   428 					ELS
   429 					lda #FEAT_CONSTANTSPEED
   430 					EIF
   431 8516 8D 54 81			sta v_aspeed
   432 8519 4C 61 85			jmp InitOfNewSetInstrumentsOnly
   433 851C			oo2
   434 851C C9 3F			cmp #63
   435 851E F0 1B			beq oo63
   436 8520 A5 D9			lda reg1
   437 8522 29 C0			and #$c0
   438 8524 F0 09			beq oo62_b
   439 8526 0A				asl @
   440 8527 2A				rol @
   441 8528 2A				rol @
   442 8529 9D EC 80			sta trackn_pause,x
   443 852C 4C 0D 85			jmp oo1x
   444 852F			oo62_b
   445 852F C8				iny
   446 8530 B1 D3			lda (ns),y
   447 8532 9D EC 80			sta trackn_pause,x
   448 8535 FE E8 80			inc trackn_idx,x
   449 8538 4C 0D 85			jmp oo1x
   450 853B			oo63
   451 853B A5 D9			lda reg1
   452 					IFT FEAT_CONSTANTSPEED==0
   453 853D 30 0C			bmi oo63_1X
   454 853F C8				iny
   455 8540 B1 D3			lda (ns),y
   456 8542 8D 12 85			sta v_bspeed
   457 8545 FE E8 80			inc trackn_idx,x
   458 8548 4C CE 84			jmp oo1i
   459 854B			oo63_1X
   460 					EIF
   461 854B C9 FF			cmp #255
   462 854D F0 09			beq oo63_11
   463 854F C8				iny
   464 8550 B1 D3			lda (ns),y
   465 8552 9D E8 80			sta trackn_idx,x
   466 8555 4C CE 84			jmp oo1i
   467 8558			oo63_11
   468 8558 4C 67 84			jmp GetSongLine
   469 855B 4C 03 86		p2xrmtp3	jmp rmt_p3
   470 855E CA			p2x0 dex
   471 855F 30 FA			 bmi p2xrmtp3
   472 8561			InitOfNewSetInstrumentsOnly
   473 8561 BC 00 81		p2x1 ldy trackn_instrx2,x
   474 8564 30 F8			bmi p2x0
   475 					IFT FEAT_SFX
   476 8566 20 74 85			jsr SetUpInstrumentY2
   477 8569 4C 5E 85			jmp p2x0
   478 856C			rmt_sfx
   479 856C 9D F0 80			sta trackn_note,x
   480 					IFT FEAT_BASS16
   481 					sta trackn_outnote,x
   482 					EIF
   483 856F A9 F0			lda #$f0				;* sfx note volume*16
   484 = 8570			RMTSFXVOLUME equ *-1		;* label for sfx note volume parameter overwriting
   485 8571 9D F4 80			sta trackn_volume,x
   486 					EIF
   487 8574			SetUpInstrumentY2
   488 8574 B1 CB			lda (p_instrstable),y
   489 8576 9D 04 81			sta trackn_instrdb,x
   490 8579 85 D7			sta nt
   491 857B C8				iny
   492 857C B1 CB			lda (p_instrstable),y
   493 857E 9D 08 81			sta trackn_instrhb,x
   494 8581 85 D8			sta nt+1
   495 					IFT FEAT_FILTER
   496 					lda #1
   497 					sta trackn_filter,x
   498 					EIF
   499 					IFT FEAT_TABLEGO
   500 					IFT FEAT_FILTER
   501 					tay
   502 					ELS
   503 8583 A0 01			ldy #1
   504 					EIF
   505 8585 B1 D7			lda (nt),y
   506 8587 9D 44 81			sta trackn_tablelop,x
   507 858A C8				iny
   508 					ELS
   509 					ldy #2
   510 					EIF
   511 858B B1 D7			lda (nt),y
   512 858D 9D 10 81			sta trackn_instrlen,x
   513 8590 C8				iny
   514 8591 B1 D7			lda (nt),y
   515 8593 9D 14 81			sta trackn_instrlop,x
   516 8596 C8				iny
   517 8597 B1 D7			lda (nt),y
   518 8599 9D 34 81			sta trackn_tabletypespeed,x
   519 					IFT FEAT_TABLETYPE||FEAT_TABLEMODE
   520 					and #$3f
   521 					EIF
   522 859C 9D 48 81			sta trackn_tablespeeda,x
   523 					IFT FEAT_TABLEMODE
   524 					lda (nt),y
   525 					and #$40
   526 					sta trackn_tablemode,x
   527 					EIF
   528 					IFT FEAT_AUDCTLMANUALSET
   529 					iny
   530 					lda (nt),y
   531 					sta trackn_audctl,x
   532 					iny
   533 					ELS
   534 859F A0 06			ldy #6
   535 					EIF
   536 85A1 B1 D7			lda (nt),y
   537 85A3 9D 1C 81			sta trackn_volumeslidedepth,x
   538 					IFT FEAT_VOLUMEMIN
   539 85A6 C8				iny
   540 85A7 B1 D7			lda (nt),y
   541 85A9 9D 24 81			sta trackn_volumemin,x
   542 					IFT FEAT_EFFECTS
   543 85AC C8				iny
   544 					EIF
   545 					ELS
   546 					IFT FEAT_EFFECTS
   547 					ldy #8
   548 					EIF
   549 					EIF
   550 					IFT FEAT_EFFECTS
   551 85AD B1 D7			lda (nt),y
   552 85AF 9D 28 81			sta trackn_effdelay,x
   553 					IFT FEAT_EFFECTVIBRATO
   554 85B2 C8				iny
   555 85B3 B1 D7			lda (nt),y
   556 85B5 A8				tay
   557 85B6 B9 92 81			lda vibtabbeg,y
   558 85B9 9D 2C 81			sta trackn_effvibratoa,x
   559 					EIF
   560 					IFT FEAT_EFFECTFSHIFT
   561 85BC A0 0A			ldy #10
   562 85BE B1 D7			lda (nt),y
   563 85C0 9D 30 81			sta trackn_effshift,x
   564 					EIF
   565 					EIF
   566 85C3 A9 80			lda #128
   567 85C5 9D 20 81			sta trackn_volumeslidevalue,x
   568 85C8 9D 00 81			sta trackn_instrx2,x
   569 85CB 0A				asl @
   570 85CC 9D 18 81			sta trackn_instrreachend,x
   571 85CF 9D FC 80			sta trackn_shiftfrq,x
   572 85D2 A8				tay
   573 85D3 B1 D7			lda (nt),y
   574 85D5 9D 40 81			sta trackn_tableend,x
   575 85D8 69 00			adc #0
   576 85DA 9D 0C 81			sta trackn_instridx,x
   577 85DD A9 0C			lda #INSTRPAR
   578 85DF 9D 3C 81			sta trackn_tablea,x
   579 85E2 A8				tay
   580 85E3 B1 D7			lda (nt),y
   581 85E5 9D 38 81			sta trackn_tablenote,x
   582 85E8			xata_rtshere
   583 					IFT FEAT_SFX
   584 85E8 60				rts
   585 					ELS
   586 					jmp p2x0
   587 					EIF
   588 85E9			rmt_play
   589 85E9			rmt_p0
   590 85E9 20 37 87			jsr SetPokey
   591 85EC			rmt_p1
   592 					IFT FEAT_INSTRSPEED==0||FEAT_INSTRSPEED>1
   593 					dec v_ainstrspeed
   594 					bne rmt_p3
   595 					EIF
   596 					IFT FEAT_INSTRSPEED==0
   597 					lda #$ff
   598 				v_instrspeed	equ *-1
   599 					sta v_ainstrspeed
   600 					ELI FEAT_INSTRSPEED>1
   601 					lda #FEAT_INSTRSPEED
   602 					sta v_ainstrspeed
   603 					EIF
   604 85EC			rmt_p2
   605 85EC CE 54 81			dec v_aspeed
   606 85EF D0 12			bne rmt_p3
   607 85F1 EE F5 85			inc v_abeat
   608 85F4 A9 FF			lda #$ff
   609 = 85F5			v_abeat equ *-1
   610 85F6 C9 FF			cmp #$ff
   611 = 85F7			v_maxtracklen equ *-1
   612 85F8 F0 03			beq p2o3
   613 85FA 4C B7 84			jmp GetTrackLine
   614 85FD			p2o3
   615 85FD 4C 67 84			jmp GetSongLineTrackLineInitOfNewSetInstrumentsOnlyRmtp3
   616 8600 4C 26 87		go_ppnext	jmp ppnext
   617 8603			rmt_p3
   618 8603 A9 82			lda #>frqtab
   619 8605 85 D6			sta nr+1
   620 8607 A2 03		xtracks05sub1	ldx #TRACKS-1
   621 8609			pp1
   622 8609 BD 08 81			lda trackn_instrhb,x
   623 860C F0 F2			beq go_ppnext
   624 860E 85 D4			sta ns+1
   625 8610 BD 04 81			lda trackn_instrdb,x
   626 8613 85 D3			sta ns
   627 8615 BC 0C 81			ldy trackn_instridx,x
   628 8618 B1 D3			lda (ns),y
   629 861A 85 D9			sta reg1
   630 861C C8				iny
   631 861D B1 D3			lda (ns),y
   632 861F 85 DA			sta reg2
   633 8621 C8				iny
   634 8622 B1 D3			lda (ns),y
   635 8624 85 DB			sta reg3
   636 8626 C8				iny
   637 8627 98				tya
   638 8628 DD 10 81			cmp trackn_instrlen,x
   639 862B 90 0A			bcc pp2
   640 862D F0 08			beq pp2
   641 862F A9 80			lda #$80
   642 8631 9D 18 81			sta trackn_instrreachend,x
   643 8634			pp1b
   644 8634 BD 14 81			lda trackn_instrlop,x
   645 8637 9D 0C 81		pp2	sta trackn_instridx,x
   646 863A A5 D9			lda reg1
   647 					IFT TRACKS>4
   648 					cpx #4
   649 					bcc pp2s
   650 					lsr @
   651 					lsr @
   652 					lsr @
   653 					lsr @
   654 				pp2s
   655 					EIF
   656 863C 29 0F			and #$0f
   657 863E 1D F4 80			ora trackn_volume,x
   658 8641 A8				tay
   659 8642 B9 00 83			lda volumetab,y
   660 8645 85 DC			sta tmp
   661 8647 A5 DA			lda reg2
   662 8649 29 0E			and #$0e
   663 864B A8				tay
   664 864C B9 82 81			lda tabbeganddistor,y
   665 864F 85 D5			sta nr
   666 8651 A5 DC			lda tmp
   667 8653 19 83 81			ora tabbeganddistor+1,y
   668 8656 9D 50 81			sta trackn_audc,x
   669 8659			InstrumentsEffects
   670 					IFT FEAT_EFFECTS
   671 8659 BD 28 81			lda trackn_effdelay,x
   672 865C F0 21			beq ei2
   673 865E C9 01			cmp #1
   674 8660 D0 1A			bne ei1
   675 8662 BD FC 80			lda trackn_shiftfrq,x
   676 					IFT FEAT_EFFECTFSHIFT
   677 8665 18				clc
   678 8666 7D 30 81			adc trackn_effshift,x
   679 					EIF
   680 					IFT FEAT_EFFECTVIBRATO
   681 8669 18				clc
   682 866A BC 2C 81			ldy trackn_effvibratoa,x
   683 866D 79 96 81			adc vib0,y
   684 					EIF
   685 8670 9D FC 80			sta trackn_shiftfrq,x
   686 					IFT FEAT_EFFECTVIBRATO
   687 8673 B9 AB 81			lda vibtabnext,y
   688 8676 9D 2C 81			sta trackn_effvibratoa,x
   689 					EIF
   690 8679 4C 7F 86			jmp ei2
   691 867C			ei1
   692 867C DE 28 81			dec trackn_effdelay,x
   693 867F			ei2
   694 					EIF
   695 867F BC 40 81			ldy trackn_tableend,x
   696 8682 C0 0D			cpy #INSTRPAR+1
   697 8684 90 31			bcc ei3
   698 8686 BD 48 81			lda trackn_tablespeeda,x
   699 8689 10 26			bpl ei2f
   700 868B			ei2c
   701 868B 98				tya
   702 868C DD 3C 81			cmp trackn_tablea,x
   703 868F D0 08			bne ei2c2
   704 					IFT FEAT_TABLEGO
   705 8691 BD 44 81			lda trackn_tablelop,x
   706 					ELS
   707 					lda #INSTRPAR
   708 					EIF
   709 8694 9D 3C 81			sta trackn_tablea,x
   710 8697 D0 03			bne ei2a
   711 8699			ei2c2
   712 8699 FE 3C 81			inc trackn_tablea,x
   713 869C			ei2a
   714 869C BD 04 81			lda trackn_instrdb,x
   715 869F 85 D7			sta nt
   716 86A1 BD 08 81			lda trackn_instrhb,x
   717 86A4 85 D8			sta nt+1
   718 86A6 BC 3C 81			ldy trackn_tablea,x
   719 86A9 B1 D7			lda (nt),y
   720 					IFT FEAT_TABLEMODE
   721 					ldy trackn_tablemode,x
   722 					beq ei2e
   723 					clc
   724 					adc trackn_tablenote,x
   725 				ei2e
   726 					EIF
   727 86AB 9D 38 81			sta trackn_tablenote,x
   728 86AE BD 34 81			lda trackn_tabletypespeed,x
   729 					IFT FEAT_TABLETYPE||FEAT_TABLEMODE
   730 					and #$3f
   731 					EIF
   732 86B1			ei2f
   733 86B1 38				sec
   734 86B2 E9 01			sbc #1
   735 86B4 9D 48 81			sta trackn_tablespeeda,x
   736 86B7			ei3
   737 86B7 BD 18 81			lda trackn_instrreachend,x
   738 86BA 10 1F			bpl ei4
   739 86BC BD F4 80			lda trackn_volume,x
   740 86BF F0 1A			beq ei4
   741 					IFT FEAT_VOLUMEMIN
   742 86C1 DD 24 81			cmp trackn_volumemin,x
   743 86C4 F0 15			beq ei4
   744 86C6 90 13			bcc ei4
   745 					EIF
   746 86C8 A8				tay
   747 86C9 BD 20 81			lda trackn_volumeslidevalue,x
   748 86CC 18				clc
   749 86CD 7D 1C 81			adc trackn_volumeslidedepth,x
   750 86D0 9D 20 81			sta trackn_volumeslidevalue,x
   751 86D3 90 06			bcc ei4
   752 86D5 98				tya
   753 86D6 E9 10			sbc #16
   754 86D8 9D F4 80			sta trackn_volume,x
   755 86DB			ei4
   756 					IFT FEAT_COMMAND2
   757 86DB A9 00			lda #0
   758 86DD 85 DD			sta frqaddcmd2
   759 					EIF
   760 					IFT FEAT_COMMAND1||FEAT_COMMAND2||FEAT_COMMAND3||FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   761 86DF A5 DA			lda reg2
   762 					IFT FEAT_FILTER||FEAT_BASS16
   763 					sta trackn_command,x
   764 					EIF
   765 86E1 29 70			and #$70
   766 					IFT 1==[FEAT_COMMAND1+FEAT_COMMAND2+FEAT_COMMAND3+FEAT_COMMAND4+FEAT_COMMAND5+FEAT_COMMAND6+[FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY]]
   767 					beq cmd0
   768 					ELS
   769 86E3 4A				lsr @
   770 86E4 4A				lsr @
   771 86E5 8D E9 86			sta jmx+1
   772 86E8 90 FE		jmx	bcc *
   773 86EA 4C 04 87			jmp cmd0
   774 86ED EA				nop
   775 86EE 4C F5 86			jmp cmd1
   776 					IFT FEAT_COMMAND2||FEAT_COMMAND3||FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   777 86F1 EA				nop
   778 86F2 4C FA 86			jmp cmd2
   779 					EIF
   780 					IFT FEAT_COMMAND3||FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   781 					nop
   782 					jmp cmd3
   783 					EIF
   784 					IFT FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   785 					nop
   786 					jmp cmd4
   787 					EIF
   788 					IFT FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   789 					nop
   790 					jmp cmd5
   791 					EIF
   792 					IFT FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   793 					nop
   794 					jmp cmd6
   795 					EIF
   796 					IFT FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   797 					nop
   798 					jmp cmd7
   799 					EIF
   800 					EIF
   801 					ELS
   802 					IFT FEAT_FILTER||FEAT_BASS16
   803 					lda reg2
   804 					sta trackn_command,x
   805 					EIF
   806 					EIF
   807 86F5			cmd1
   808 					IFT FEAT_COMMAND1
   809 86F5 A5 DB			lda reg3
   810 86F7 4C 23 87			jmp cmd0c
   811 					EIF
   812 86FA			cmd2
   813 					IFT FEAT_COMMAND2
   814 86FA A5 DB			lda reg3
   815 86FC 85 DD			sta frqaddcmd2
   816 86FE BD F0 80			lda trackn_note,x
   817 8701 4C 0A 87			jmp cmd0a
   818 					EIF
   819 8704			cmd3
   820 					IFT FEAT_COMMAND3
   821 					lda trackn_note,x
   822 					clc
   823 					adc reg3
   824 					sta trackn_note,x
   825 					jmp cmd0a
   826 					EIF
   827 8704			cmd4
   828 					IFT FEAT_COMMAND4
   829 					lda trackn_shiftfrq,x
   830 					clc
   831 					adc reg3
   832 					sta trackn_shiftfrq,x
   833 					lda trackn_note,x
   834 					jmp cmd0a
   835 					EIF
   836 8704			cmd5
   837 					IFT FEAT_COMMAND5&&FEAT_PORTAMENTO
   838 					IFT FEAT_TABLETYPE
   839 					lda trackn_tabletypespeed,x
   840 					bpl cmd5a1
   841 					ldy trackn_note,x
   842 					lda (nr),y
   843 					clc
   844 					adc trackn_tablenote,x
   845 					jmp cmd5ax
   846 					EIF
   847 				cmd5a1
   848 					lda trackn_note,x
   849 					clc
   850 					adc trackn_tablenote,x
   851 					cmp #61
   852 					bcc cmd5a2
   853 					lda #63
   854 				cmd5a2
   855 					tay
   856 					lda (nr),y
   857 				cmd5ax
   858 					sta trackn_portafrqc,x
   859 					ldy reg3
   860 					bne cmd5a
   861 					sta trackn_portafrqa,x
   862 				cmd5a
   863 					tya
   864 					lsr @
   865 					lsr @
   866 					lsr @
   867 					lsr @
   868 					sta trackn_portaspeed,x
   869 					sta trackn_portaspeeda,x
   870 					lda reg3
   871 					and #$0f
   872 					sta trackn_portadepth,x
   873 					lda trackn_note,x
   874 					jmp cmd0a
   875 					ELI FEAT_COMMAND5
   876 					lda trackn_note,x
   877 					jmp cmd0a
   878 					EIF
   879 8704			cmd6
   880 					IFT FEAT_COMMAND6&&FEAT_FILTER
   881 					lda reg3
   882 					clc
   883 					adc trackn_filter,x
   884 					sta trackn_filter,x
   885 					lda trackn_note,x
   886 					jmp cmd0a
   887 					ELI FEAT_COMMAND6
   888 					lda trackn_note,x
   889 					jmp cmd0a
   890 					EIF
   891 8704			cmd7
   892 					IFT FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   893 					IFT FEAT_COMMAND7SETNOTE
   894 					lda reg3
   895 					IFT FEAT_COMMAND7VOLUMEONLY
   896 					cmp #$80
   897 					beq cmd7a
   898 					EIF
   899 					sta trackn_note,x
   900 					jmp cmd0a
   901 					EIF
   902 					IFT FEAT_COMMAND7VOLUMEONLY
   903 				cmd7a
   904 					lda trackn_audc,x
   905 					ora #$f0
   906 					sta trackn_audc,x
   907 					lda trackn_note,x
   908 					jmp cmd0a
   909 					EIF
   910 					EIF
   911 8704			cmd0
   912 8704 BD F0 80			lda trackn_note,x
   913 8707 18				clc
   914 8708 65 DB			adc reg3
   915 870A			cmd0a
   916 					IFT FEAT_TABLETYPE
   917 					ldy trackn_tabletypespeed,x
   918 					bmi cmd0b
   919 					EIF
   920 870A 18				clc
   921 870B 7D 38 81			adc trackn_tablenote,x
   922 870E C9 3D			cmp #61
   923 8710 90 07			bcc cmd0a1
   924 8712 A9 00			lda #0
   925 8714 9D 50 81			sta trackn_audc,x
   926 8717 A9 3F			lda #63
   927 8719			cmd0a1
   928 					IFT FEAT_BASS16
   929 					sta trackn_outnote,x
   930 					EIF
   931 8719 A8				tay
   932 871A B1 D5			lda (nr),y
   933 871C 18				clc
   934 871D 7D FC 80			adc trackn_shiftfrq,x
   935 					IFT FEAT_COMMAND2
   936 8720 18				clc
   937 8721 65 DD			adc frqaddcmd2
   938 					EIF
   939 					IFT FEAT_TABLETYPE
   940 					jmp cmd0c
   941 				cmd0b
   942 					cmp #61
   943 					bcc cmd0b1
   944 					lda #0
   945 					sta trackn_audc,x
   946 					lda #63
   947 				cmd0b1
   948 					tay
   949 					lda trackn_shiftfrq,x
   950 					clc
   951 					adc trackn_tablenote,x
   952 					clc
   953 					adc (nr),y
   954 					IFT FEAT_COMMAND2
   955 					clc
   956 					adc frqaddcmd2
   957 					EIF
   958 					EIF
   959 8723			cmd0c
   960 8723 9D 4C 81			sta trackn_audf,x
   961 8726			pp9
   962 					IFT FEAT_PORTAMENTO
   963 					lda trackn_portaspeeda,x
   964 					beq pp10
   965 					dec trackn_portaspeeda,x
   966 					bne pp10
   967 					lda trackn_portaspeed,x
   968 					sta trackn_portaspeeda,x
   969 					lda trackn_portafrqa,x
   970 					cmp trackn_portafrqc,x
   971 					beq pp10
   972 					bcs pps1
   973 					adc trackn_portadepth,x
   974 					bcs pps8
   975 					cmp trackn_portafrqc,x
   976 					bcs pps8
   977 					jmp pps9
   978 				pps1
   979 					sbc trackn_portadepth,x
   980 					bcc pps8
   981 					cmp trackn_portafrqc,x
   982 					bcs pps9
   983 				pps8
   984 					lda trackn_portafrqc,x
   985 				pps9
   986 					sta trackn_portafrqa,x
   987 				pp10
   988 					lda reg2
   989 					and #$01
   990 					beq pp11
   991 					lda trackn_portafrqa,x
   992 					clc
   993 					adc trackn_shiftfrq,x
   994 					sta trackn_audf,x
   995 				pp11
   996 					EIF
   997 8726			ppnext
   998 8726 CA				dex
   999 8727 30 03			bmi rmt_p4
  1000 8729 4C 09 86			jmp pp1
  1001 872C			rmt_p4
  1002 					IFT FEAT_AUDCTLMANUALSET
  1003 					lda trackn_audctl+0
  1004 					ora trackn_audctl+1
  1005 					ora trackn_audctl+2
  1006 					ora trackn_audctl+3
  1007 					tax
  1008 					ELS
  1009 872C A2 00			ldx #0
  1010 					EIF
  1011 872E			qq1
  1012 872E 8E 38 87			stx v_audctl
  1013 					IFT FEAT_FILTER
  1014 					IFT FEAT_FILTERG0L
  1015 					lda trackn_command+0
  1016 					bpl qq2
  1017 					lda trackn_audc+0
  1018 					and #$0f
  1019 					beq qq2
  1020 					lda trackn_audf+0
  1021 					clc
  1022 					adc trackn_filter+0
  1023 					sta trackn_audf+2
  1024 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2L
  1025 					lda trackn_audc+2
  1026 					and #$10
  1027 					bne qq1a
  1028 					EIF
  1029 					lda #0
  1030 					sta trackn_audc+2
  1031 				qq1a
  1032 					txa
  1033 					ora #4
  1034 					tax
  1035 					EIF
  1036 				qq2
  1037 					IFT FEAT_FILTERG1L
  1038 					lda trackn_command+1
  1039 					bpl qq3
  1040 					lda trackn_audc+1
  1041 					and #$0f
  1042 					beq qq3
  1043 					lda trackn_audf+1
  1044 					clc
  1045 					adc trackn_filter+1
  1046 					sta trackn_audf+3
  1047 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG3L
  1048 					lda trackn_audc+3
  1049 					and #$10
  1050 					bne qq2a
  1051 					EIF
  1052 					lda #0
  1053 					sta trackn_audc+3
  1054 				qq2a
  1055 					txa
  1056 					ora #2
  1057 					tax
  1058 					EIF
  1059 				qq3
  1060 					IFT FEAT_FILTERG0L||FEAT_FILTERG1L
  1061 					cpx v_audctl
  1062 					bne qq5
  1063 					EIF
  1064 					EIF
  1065 					IFT FEAT_BASS16
  1066 					IFT FEAT_BASS16G1L
  1067 					lda trackn_command+1
  1068 					and #$0e
  1069 					cmp #6
  1070 					bne qq4
  1071 					lda trackn_audc+1
  1072 					and #$0f
  1073 					beq qq4
  1074 					ldy trackn_outnote+1
  1075 					lda frqtabbasslo,y
  1076 					sta trackn_audf+0
  1077 					lda frqtabbasshi,y
  1078 					sta trackn_audf+1
  1079 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG0L
  1080 					lda trackn_audc+0
  1081 					and #$10
  1082 					bne qq3a
  1083 					EIF
  1084 					lda #0
  1085 					sta trackn_audc+0
  1086 				qq3a
  1087 					txa
  1088 					ora #$50
  1089 					tax
  1090 					EIF
  1091 				qq4
  1092 					IFT FEAT_BASS16G3L
  1093 					lda trackn_command+3
  1094 					and #$0e
  1095 					cmp #6
  1096 					bne qq5
  1097 					lda trackn_audc+3
  1098 					and #$0f
  1099 					beq qq5
  1100 					ldy trackn_outnote+3
  1101 					lda frqtabbasslo,y
  1102 					sta trackn_audf+2
  1103 					lda frqtabbasshi,y
  1104 					sta trackn_audf+3
  1105 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2L
  1106 					lda trackn_audc+2
  1107 					and #$10
  1108 					bne qq4a
  1109 					EIF
  1110 					lda #0
  1111 					sta trackn_audc+2
  1112 				qq4a
  1113 					txa
  1114 					ora #$28
  1115 					tax
  1116 					EIF
  1117 					EIF
  1118 8731			qq5
  1119 8731 8E 38 87			stx v_audctl
  1120 					IFT TRACKS>4
  1121 					IFT FEAT_AUDCTLMANUALSET
  1122 					lda trackn_audctl+4
  1123 					ora trackn_audctl+5
  1124 					ora trackn_audctl+6
  1125 					ora trackn_audctl+7
  1126 					tax
  1127 					ELS
  1128 					ldx #0
  1129 					EIF
  1130 					stx v_audctl2
  1131 					IFT FEAT_FILTER
  1132 					IFT FEAT_FILTERG0R
  1133 					lda trackn_command+0+4
  1134 					bpl qs2
  1135 					lda trackn_audc+0+4
  1136 					and #$0f
  1137 					beq qs2
  1138 					lda trackn_audf+0+4
  1139 					clc
  1140 					adc trackn_filter+0+4
  1141 					sta trackn_audf+2+4
  1142 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2R
  1143 					lda trackn_audc+2+4
  1144 					and #$10
  1145 					bne qs1a
  1146 					EIF
  1147 					lda #0
  1148 					sta trackn_audc+2+4
  1149 				qs1a
  1150 					txa
  1151 					ora #4
  1152 					tax
  1153 					EIF
  1154 				qs2
  1155 					IFT FEAT_FILTERG1R
  1156 					lda trackn_command+1+4
  1157 					bpl qs3
  1158 					lda trackn_audc+1+4
  1159 					and #$0f
  1160 					beq qs3
  1161 					lda trackn_audf+1+4
  1162 					clc
  1163 					adc trackn_filter+1+4
  1164 					sta trackn_audf+3+4
  1165 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG3R
  1166 					lda trackn_audc+3+4
  1167 					and #$10
  1168 					bne qs2a
  1169 					EIF
  1170 					lda #0
  1171 					sta trackn_audc+3+4
  1172 				qs2a
  1173 					txa
  1174 					ora #2
  1175 					tax
  1176 					EIF
  1177 				qs3
  1178 					IFT FEAT_FILTERG0R||FEAT_FILTERG1R
  1179 					cpx v_audctl2
  1180 					bne qs5
  1181 					EIF
  1182 					EIF
  1183 					IFT FEAT_BASS16
  1184 					IFT FEAT_BASS16G1R
  1185 					lda trackn_command+1+4
  1186 					and #$0e
  1187 					cmp #6
  1188 					bne qs4
  1189 					lda trackn_audc+1+4
  1190 					and #$0f
  1191 					beq qs4
  1192 					ldy trackn_outnote+1+4
  1193 					lda frqtabbasslo,y
  1194 					sta trackn_audf+0+4
  1195 					lda frqtabbasshi,y
  1196 					sta trackn_audf+1+4
  1197 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG0R
  1198 					lda trackn_audc+0+4
  1199 					and #$10
  1200 					bne qs3a
  1201 					EIF
  1202 					lda #0
  1203 					sta trackn_audc+0+4
  1204 				qs3a
  1205 					txa
  1206 					ora #$50
  1207 					tax
  1208 					EIF
  1209 				qs4
  1210 					IFT FEAT_BASS16G3R
  1211 					lda trackn_command+3+4
  1212 					and #$0e
  1213 					cmp #6
  1214 					bne qs5
  1215 					lda trackn_audc+3+4
  1216 					and #$0f
  1217 					beq qs5
  1218 					ldy trackn_outnote+3+4
  1219 					lda frqtabbasslo,y
  1220 					sta trackn_audf+2+4
  1221 					lda frqtabbasshi,y
  1222 					sta trackn_audf+3+4
  1223 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2R
  1224 					lda trackn_audc+2+4
  1225 					and #$10
  1226 					bne qs4a
  1227 					EIF
  1228 					lda #0
  1229 					sta trackn_audc+2+4
  1230 				qs4a
  1231 					txa
  1232 					ora #$28
  1233 					tax
  1234 					EIF
  1235 					EIF
  1236 				qs5
  1237 					stx v_audctl2
  1238 					EIF
  1239 8734			rmt_p5
  1240 					IFT FEAT_INSTRSPEED==0||FEAT_INSTRSPEED>1
  1241 					lda #$ff
  1242 				v_ainstrspeed equ *-1
  1243 					ELS
  1244 8734 A9 01			lda #1
  1245 					EIF
  1246 8736 60				rts
  1247 8737			SetPokey
  1248 					IFT STEREOMODE==1		;* L1 L2 L3 L4 R1 R2 R3 R4
  1249 					ldy #$ff
  1250 				v_audctl2 equ *-1
  1251 					lda trackn_audf+0+4
  1252 					ldx trackn_audf+0
  1253 				xstastx01	sta $d210
  1254 					stx $d200
  1255 					lda trackn_audc+0+4
  1256 					ldx trackn_audc+0
  1257 				xstastx02	sta $d211
  1258 					stx $d201
  1259 					lda trackn_audf+1+4
  1260 					ldx trackn_audf+1
  1261 				xstastx03	sta $d212
  1262 					stx $d202
  1263 					lda trackn_audc+1+4
  1264 					ldx trackn_audc+1
  1265 				xstastx04	sta $d213
  1266 					stx $d203
  1267 					lda trackn_audf+2+4
  1268 					ldx trackn_audf+2
  1269 				xstastx05	sta $d214
  1270 					stx $d204
  1271 					lda trackn_audc+2+4
  1272 					ldx trackn_audc+2
  1273 				xstastx06	sta $d215
  1274 					stx $d205
  1275 					lda trackn_audf+3+4
  1276 					ldx trackn_audf+3
  1277 				xstastx07	sta $d216
  1278 					stx $d206
  1279 					lda trackn_audc+3+4
  1280 					ldx trackn_audc+3
  1281 				xstastx08	sta $d217
  1282 					stx $d207
  1283 					lda #$ff
  1284 				v_audctl equ *-1
  1285 				xstysta01	sty $d218
  1286 					sta $d208
  1287 					ELI STEREOMODE==0		;* L1 L2 L3 L4
  1288 8737 A0 FF			ldy #$ff
  1289 = 8738			v_audctl equ *-1
  1290 8739 AD 4C 81			lda trackn_audf+0
  1291 873C AE 50 81			ldx trackn_audc+0
  1292 873F 8D 00 D2			sta $d200
  1293 8742 8E 01 D2			stx $d201
  1294 8745 AD 4D 81			lda trackn_audf+1
  1295 8748 AE 51 81			ldx trackn_audc+1
  1296 874B 8D 02 D2			sta $d200+2
  1297 874E 8E 03 D2			stx $d201+2
  1298 8751 AD 4E 81			lda trackn_audf+2
  1299 8754 AE 52 81			ldx trackn_audc+2
  1300 8757 8D 04 D2			sta $d200+4
  1301 875A 8E 05 D2			stx $d201+4
  1302 875D AD 4F 81			lda trackn_audf+3
  1303 8760 AE 53 81			ldx trackn_audc+3
  1304 8763 8D 06 D2			sta $d200+6
  1305 8766 8E 07 D2			stx $d201+6
  1306 8769 8C 08 D2			sty $d208
  1307 					ELI STEREOMODE==2		;* L1 R2 R3 L4
  1308 					ldy #$ff
  1309 				v_audctl equ *-1
  1310 					lda trackn_audf+0
  1311 					ldx trackn_audc+0
  1312 					sta $d200
  1313 					stx $d201
  1314 					sta $d210
  1315 					lda trackn_audf+1
  1316 					ldx trackn_audc+1
  1317 					sta $d210+2
  1318 					stx $d211+2
  1319 					lda trackn_audf+2
  1320 					ldx trackn_audc+2
  1321 					sta $d210+4
  1322 					stx $d211+4
  1323 					sta $d200+4
  1324 					lda trackn_audf+3
  1325 					ldx trackn_audc+3
  1326 					sta $d200+6
  1327 					stx $d201+6
  1328 					sta $d210+6
  1329 					sty $d218
  1330 					sty $d208
  1331 					ELI STEREOMODE==3		;* L1 L2 R3 R4
  1332 					ldy #$ff
  1333 				v_audctl equ *-1
  1334 					lda trackn_audf+0
  1335 					ldx trackn_audc+0
  1336 					sta $d200
  1337 					stx $d201
  1338 					lda trackn_audf+1
  1339 					ldx trackn_audc+1
  1340 					sta $d200+2
  1341 					stx $d201+2
  1342 					lda trackn_audf+2
  1343 					ldx trackn_audc+2
  1344 					sta $d210+4
  1345 					stx $d211+4
  1346 					sta $d200+4
  1347 					lda trackn_audf+3
  1348 					ldx trackn_audc+3
  1349 					sta $d210+6
  1350 					stx $d211+6
  1351 					sta $d200+6
  1352 					sty $d218
  1353 					sty $d208
  1354 					EIF
  1355 876C 60				rts
  1356 876D			RMTPLAYEREND
    14 				;
    15 				;
    16 					opt h-						;RMT module is standard Atari binary file already
    17 876D FF FF 70 87 DC A9 + 	ins "sfx.rmt"				;include music RMT module
    18 					opt h+
    19 				;
    20 				;
    21 				;
    22 A9E0				org SFX_CODE 
    23 					
    24 AA50			new_init                        ; Set VBI address depending on the NTSC or PAL	
    25 AA50-AAEE> 78			sei
    26 AA51 AD 0B D4		loop lda $D40B; vcount
    27 AA54 CD 0B D4		    cmp $D40B; vcount
    28 AA57 F0 FB		    beq *-3
    29 AA59 90 F6		    bcc loop
    30 AA5B C9 83		    cmp #131 ;; BCC #132
    31 AA5D 58				cli
    32 AA5E B0 0A		    BCS finish_init ; PAL
    33 					;ntsc
    34 AA60 A9 8E			lda #<ntsc_vbi   ; low byte
    35 AA62 8D EC AA			sta vbi_address ; low
    36 AA65 A9 AA			lda #>ntsc_vbi   ; hi byte
    37 AA67 8D ED AA			sta vbi_address+1 ; hi
    38 AA6A			finish_init
    39 AA6A AD 24 02 8D E4 AA + 	mwa $224 old_vbi			; Store old VBI
    40 					
    41 				; SET VBI
    42 AA76			enable_vbi:
    43 AA76 AC EC AA			ldy vbi_address
    44 AA79 AE ED AA			ldx vbi_address+1
    45 AA7C A9 07			lda #$07
    46 AA7E 20 5C E4			jsr $e45c					;Start VBI routine
    47 AA81 60				rts
    48
    49 				; restore old VBI routine
    50 AA82			disable_vbi 
    51 AA82 AC E4 AA			ldy old_vbi
    52 AA85 AE E5 AA			ldx old_vbi+1
    53 AA88 A9 07			lda #$07
    54 AA8A 20 5C E4			jsr $e45c					;Start VBI routine
    55 AA8D 60			    rts
    56 				;
    57
    58 AA8E			ntsc_vbi
    59 AA8E CE EB AA			dec	ntsc_counter
    60 AA91 D0 08			bne	vbi
    61 AA93 A9 05			lda #5
    62 AA95 8D EB AA			sta ntsc_counter	
    63 AA98 4C E1 AA		    jmp end_vbi
    64
    65 AA9B			vbi
    66 AA9B AD EE AA			lda vbi_counter
    67 AA9E F0 03			beq skip_counter	; skip decrease if zero
    68 AAA0 CE EE AA			dec vbi_counter
    69 AAA3			skip_counter:
    70
    71 AAA3 AD EA AA			lda call_silence
    72 AAA6 F0 08			beq skip_silence
    73 AAA8 20 09 84			jsr RASTERMUSICTRACKER+9
    74 AAAB A9 00			lda #$0
    75 AAAD 8D EA AA			sta call_silence				;reinit value
    76 					
    77 AAB0			skip_silence:
    78
    79 AAB0 AD E9 AA			lda sound_active
    80 AAB3 F0 2C			beq end_vbi
    81 					
    82 				;
    83 AAB5 AD E6 AA			lda sfx_effect
    84 AAB8 30 0E			bmi music_part	; if #$FF
    85 AABA 0A				asl @						; * 2
    86 AABB A8				tay							;Y = 2,4,..,16	instrument number * 2 (0,2,4,..,126)
    87 AABC A2 03			ldx #3						;X = 3			channel (0..3 or 0..7 for stereo module)
    88 AABE A9 00			lda #0						;A = 12			note (0..60)
    89 AAC0 20 0F 84			jsr RASTERMUSICTRACKER+15	;RMT_SFX start tone (It works only if FEAT_SFX is enabled !!!)
    90
    91 AAC3 A9 FF			lda #$ff
    92 AAC5 8D E6 AA			sta sfx_effect				;reinit value
    93
    94 AAC8			music_part:
    95 AAC8 AD E8 AA		    lda music_plays
    96 AACB F0 14		    beq end_vbi
    97
    98 AACD AD E7 AA			lda track_to_play
    99 AAD0 30 0C			bmi not_setting_track	    ; if $ff then we are not setting a track
   100 					
   101 AAD2 A2 70			ldx #<MODUL					;low byte of RMT module to X reg
   102 AAD4 A0 87			ldy #>MODUL					;hi byte of RMT module to Y reg
   103 AAD6 20 00 84			jsr RASTERMUSICTRACKER		;Init
   104 					
   105 AAD9 A9 FF			lda #$ff
   106 AADB 8D E7 AA			sta track_to_play				;reinit value
   107
   108 AADE			not_setting_track:
   109 AADE 20 03 84			jsr RASTERMUSICTRACKER+3	;1 play
   110
   111 AAE1			end_vbi:
   112 AAE1 4C 62 E4			jmp $e462					;end vbi
   113 				;
   114 				;
   115 				;
   116 AAE4 00 00		old_vbi dta 0,0
   117 AAE6 FF			sfx_effect dta $ff				;sfx number variable
   118 AAE7 FF			track_to_play dta $ff			;track to play
   119 AAE8 01			music_plays dta 1				;1 if plays - turnable with option key
   120 AAE9 01			sound_active dta 1				;1 if active
   121 AAEA 00			call_silence dta 0
   122 AAEB 05			ntsc_counter dta 5
   123 AAEC 9B AA		vbi_address dta .LO(vbi), .HI(vbi)
   124 AAEE 00			vbi_counter dta 0
