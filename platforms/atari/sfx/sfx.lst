mads 1.9.6 build 89 (3 Apr 13)
Source: sfx.a65
     1 				;
     2 				; SFX
     3 				; example by raster/c.p.u., 2006,2009
     4 				;
     5 				;
     6 = 0000			STEREOMODE	equ 0				;0 => compile RMTplayer for mono 4 tracks
     7 				;								;1 => compile RMTplayer for stereo 8 tracks
     8 				;								;2 => compile RMTplayer for 4 tracks stereo L1 R2 R3 L4
     9 				;								;3 => compile RMTplayer for 4 tracks stereo L1 L2 R3 R4
    10 				;
    11 				;
    12 					icl "addresses.a65"			;include addresses
Source: addresses.a65
     1 = 2300			PLAYER    equ $2300
     2 = 2700			MODUL     equ $2700
     3 = 4950			SFX_CODE  equ $4950
    13 					icl "rmtplayr.a65"			;include RMT player routine
Source: rmtplayr.a65
     1 				;*
     2 				;* Raster Music Tracker, RMT Atari routine version 1.20090108
     3 				;* (c) Radek Sterba, Raster/C.P.U., 2002 - 2009
     4 				;* http://raster.atari.org
     5 				;*
     6 				;* Warnings:
     7 				;*
     8 				;* 1. RMT player routine needs 19 itself reserved bytes in zero page (no accessed
     9 				;*    from any other routines) as well as cca 1KB of memory before the "PLAYER"
    10 				;*    address for frequency tables and functionary variables. It's:
    11 				;*	  a) from PLAYER-$03c0 to PLAYER for stereo RMTplayer
    12 				;*    b) from PLAYER-$0320 to PLAYER for mono RMTplayer
    13 				;*
    14 				;* 2. RMT player routine MUST (!!!) be compiled from the begin of the memory page.
    15 				;*    i.e. "PLAYER" address can be $..00 only!
    16 				;*
    17 				;* 3. Because of RMTplayer provides a lot of effects, it spent a lot of CPU time.
    18 				;*
    19 				;* STEREOMODE	equ 0..3			;0 => compile RMTplayer for 4 tracks mono
    20 				;*									;1 => compile RMTplayer for 8 tracks stereo
    21 				;*									;2 => compile RMTplayer for 4 tracks stereo L1 R2 R3 L4
    22 				;*									;3 => compile RMTplayer for 4 tracks stereo L1 L2 R3 R4
    23 				;*
    24 					IFT STEREOMODE==1
    25 				TRACKS		equ 8
    26 					ELS
    27 = 0004			TRACKS		equ 4
    28 					EIF
    29 				;*
    30
    31 				;*
    32 				;* RMT FEATures definitions file
    33 				;* For optimizations of RMT player routine to concrete RMT modul only!
    34 					icl "rmt_feat.a65"
Source: rmt_feat.a65
     1 				;* --------BEGIN--------
     2 				;* D:\Projekty\RobboIsYou\platforms\atari\sfx\sfx.rmt
     3 = 0001			FEAT_SFX		equ 1
     4 = 0000			FEAT_GLOBALVOLUMEFADE	equ 0		;RMTGLOBALVOLUMEFADE variable
     5 = 0000			FEAT_NOSTARTINGSONGLINE	equ 0
     6 = 0001			FEAT_INSTRSPEED		equ 1
     7 = 0000			FEAT_CONSTANTSPEED		equ 0		;(27 times)
     8 = 0001			FEAT_COMMAND1		equ 1		;(199 times)
     9 = 0001			FEAT_COMMAND2		equ 1		;(26 times)
    10 = 0000			FEAT_COMMAND3		equ 0		;(0 times)
    11 = 0000			FEAT_COMMAND4		equ 0		;(0 times)
    12 = 0000			FEAT_COMMAND5		equ 0		;(0 times)
    13 = 0000			FEAT_COMMAND6		equ 0		;(0 times)
    14 = 0000			FEAT_COMMAND7SETNOTE		equ 0		;(0 times)
    15 = 0000			FEAT_COMMAND7VOLUMEONLY		equ 0		;(0 times)
    16 = 0000			FEAT_PORTAMENTO		equ 0		;(0 times)
    17 = 0000			FEAT_FILTER		equ 0		;(0 times)
    18 = 0000			FEAT_FILTERG0L		equ 0		;(0 times)
    19 = 0000			FEAT_FILTERG1L		equ 0		;(0 times)
    20 = 0000			FEAT_FILTERG0R		equ 0		;(0 times)
    21 = 0000			FEAT_FILTERG1R		equ 0		;(0 times)
    22 = 0000			FEAT_BASS16		equ 0		;(0 times)
    23 = 0000			FEAT_BASS16G1L		equ 0		;(0 times)
    24 = 0000			FEAT_BASS16G3L		equ 0		;(0 times)
    25 = 0000			FEAT_BASS16G1R		equ 0		;(0 times)
    26 = 0000			FEAT_BASS16G3R		equ 0		;(0 times)
    27 = 0000			FEAT_VOLUMEONLYG0L		equ 0		;(0 times)
    28 = 0000			FEAT_VOLUMEONLYG2L		equ 0		;(0 times)
    29 = 0000			FEAT_VOLUMEONLYG3L		equ 0		;(0 times)
    30 = 0000			FEAT_VOLUMEONLYG0R		equ 0		;(0 times)
    31 = 0000			FEAT_VOLUMEONLYG2R		equ 0		;(0 times)
    32 = 0000			FEAT_VOLUMEONLYG3R		equ 0		;(0 times)
    33 = 0000			FEAT_TABLETYPE		equ 0		;(0 times)
    34 = 0000			FEAT_TABLEMODE		equ 0		;(0 times)
    35 = 0001			FEAT_TABLEGO		equ 1		;(4 times)
    36 = 0000			FEAT_AUDCTLMANUALSET		equ 0		;(0 times)
    37 = 0001			FEAT_VOLUMEMIN		equ 1		;(5 times)
    38 = 0001			FEAT_EFFECTVIBRATO		equ 1		;(6 times)
    39 = 0001			FEAT_EFFECTFSHIFT		equ 1		;(1 times)
    40 				;* --------END--------
    35 				;*
    36 				;* RMT ZeroPage addresses
    37 					org 203
    38 				p_tis
    39 				p_instrstable	org *+2
    40 				p_trackslbstable	org *+2
    41 				p_trackshbstable	org *+2
    42 				p_song			org *+2
    43 				ns				org *+2
    44 				nr				org *+2
    45 				nt				org *+2
    46 				reg1			org *+1
    47 				reg2			org *+1
    48 				reg3			org *+1
    49 				tmp				org *+1
    50 					IFT FEAT_COMMAND2
    51 				frqaddcmd2		org *+1
    52 					EIF
    53 					IFT TRACKS>4
    54 					org PLAYER-$400+$40
    55 					ELS
    56 					org PLAYER-$400+$e0
    57 					EIF
    58 				track_variables
    59 				trackn_db	org *+TRACKS
    60 				trackn_hb	org *+TRACKS
    61 				trackn_idx	org *+TRACKS
    62 				trackn_pause	org *+TRACKS
    63 				trackn_note	org *+TRACKS
    64 				trackn_volume	org *+TRACKS
    65 				trackn_distor 	org *+TRACKS
    66 				trackn_shiftfrq	org *+TRACKS
    67 					IFT FEAT_PORTAMENTO
    68 				trackn_portafrqc org *+TRACKS
    69 				trackn_portafrqa org *+TRACKS
    70 				trackn_portaspeed org *+TRACKS
    71 				trackn_portaspeeda org *+TRACKS
    72 				trackn_portadepth org *+TRACKS
    73 					EIF
    74 				trackn_instrx2	org *+TRACKS
    75 				trackn_instrdb	org *+TRACKS
    76 				trackn_instrhb	org *+TRACKS
    77 				trackn_instridx	org *+TRACKS
    78 				trackn_instrlen	org *+TRACKS
    79 				trackn_instrlop	org *+TRACKS
    80 				trackn_instrreachend	org *+TRACKS
    81 				trackn_volumeslidedepth org *+TRACKS
    82 				trackn_volumeslidevalue org *+TRACKS
    83 					IFT FEAT_VOLUMEMIN
    84 				trackn_volumemin		org *+TRACKS
    85 					EIF
    86 = 0001			FEAT_EFFECTS equ FEAT_EFFECTVIBRATO||FEAT_EFFECTFSHIFT
    87 					IFT FEAT_EFFECTS
    88 				trackn_effdelay			org *+TRACKS
    89 					EIF
    90 					IFT FEAT_EFFECTVIBRATO
    91 				trackn_effvibratoa		org *+TRACKS
    92 					EIF
    93 					IFT FEAT_EFFECTFSHIFT
    94 				trackn_effshift		org *+TRACKS
    95 					EIF
    96 				trackn_tabletypespeed org *+TRACKS
    97 					IFT FEAT_TABLEMODE
    98 				trackn_tablemode	org *+TRACKS
    99 					EIF
   100 				trackn_tablenote	org *+TRACKS
   101 				trackn_tablea		org *+TRACKS
   102 				trackn_tableend		org *+TRACKS
   103 					IFT FEAT_TABLEGO
   104 				trackn_tablelop		org *+TRACKS
   105 					EIF
   106 				trackn_tablespeeda	org *+TRACKS
   107 					IFT FEAT_FILTER||FEAT_BASS16
   108 				trackn_command		org *+TRACKS
   109 					EIF
   110 					IFT FEAT_BASS16
   111 				trackn_outnote		org *+TRACKS
   112 					EIF
   113 					IFT FEAT_FILTER
   114 				trackn_filter		org *+TRACKS
   115 					EIF
   116 				trackn_audf	org *+TRACKS
   117 				trackn_audc	org *+TRACKS
   118 					IFT FEAT_AUDCTLMANUALSET
   119 				trackn_audctl	org *+TRACKS
   120 					EIF
   121 				v_aspeed		org *+1
   122 				track_endvariables
   123 						org PLAYER-$100-$140-$40+2
   124 = 000C			INSTRPAR	equ 12
   125 				tabbeganddistor
   126 FFFF> 2082-20BF> 80 00	 dta frqtabpure-frqtab,$00
   127 2084 80 20		 dta frqtabpure-frqtab,$20
   128 2086 80 40		 dta frqtabpure-frqtab,$40
   129 2088 00 C0		 dta frqtabbass1-frqtab,$c0
   130 208A 80 80		 dta frqtabpure-frqtab,$80
   131 208C 80 A0		 dta frqtabpure-frqtab,$a0
   132 208E 00 C0		 dta frqtabbass1-frqtab,$c0
   133 2090 40 C0		 dta frqtabbass2-frqtab,$c0
   134 						IFT FEAT_EFFECTVIBRATO
   135 2092 00 01 05 0B		vibtabbeg dta 0,vib1-vib0,vib2-vib0,vib3-vib0
   136 2096 00			vib0	dta 0
   137 2097 01 FF FF 01		vib1	dta 1,-1,-1,1
   138 209B 01 00 FF FF 00 01	vib2	dta 1,0,-1,-1,0,1
   139 20A1 01 01 00 FF FF FF + vib3	dta 1,1,0,-1,-1,-1,-1,0,1,1
   140 20AB			vibtabnext
   141 20AB 00					dta vib0-vib0+0
   142 20AC 02 03 04 01				dta vib1-vib0+1,vib1-vib0+2,vib1-vib0+3,vib1-vib0+0
   143 20B0 06 07 08 09 0A 05			dta vib2-vib0+1,vib2-vib0+2,vib2-vib0+3,vib2-vib0+4,vib2-vib0+5,vib2-vib0+0
   144 20B6 0C 0D 0E 0F 10 11 + 		dta vib3-vib0+1,vib3-vib0+2,vib3-vib0+3,vib3-vib0+4,vib3-vib0+5,vib3-vib0+6,vib3-vib0+7,vib3-vib0+8,vib3-vib0+9,vib3-vib0+0
   145 						EIF
   146 20C0					org PLAYER-$100-$140
   147 					IFT FEAT_BASS16
   148 				frqtabbasslo
   149 					dta $F2,$33,$96,$E2,$38,$8C,$00,$6A,$E8,$6A,$EF,$80,$08,$AE,$46,$E6
   150 					dta $95,$41,$F6,$B0,$6E,$30,$F6,$BB,$84,$52,$22,$F4,$C8,$A0,$7A,$55
   151 					dta $34,$14,$F5,$D8,$BD,$A4,$8D,$77,$60,$4E,$38,$27,$15,$06,$F7,$E8
   152 					dta $DB,$CF,$C3,$B8,$AC,$A2,$9A,$90,$88,$7F,$78,$70,$6A,$64,$5E,$00
   153 					EIF
   154 20C0					org PLAYER-$100-$100
   155 2100			frqtab
   156 					ERT [<frqtab]!=0	;* frqtab must begin at the memory page bound! (i.e. $..00 address)
   157 2100			frqtabbass1
   158 2100-21BF> BF B6 AA A1 + 	dta $BF,$B6,$AA,$A1,$98,$8F,$89,$80,$F2,$E6,$DA,$CE,$BF,$B6,$AA,$A1
   159 2110 98 8F 89 80 7A 71 + 	dta $98,$8F,$89,$80,$7A,$71,$6B,$65,$5F,$5C,$56,$50,$4D,$47,$44,$3E
   160 2120 3C 38 35 32 2F 2D + 	dta $3C,$38,$35,$32,$2F,$2D,$2A,$28,$25,$23,$21,$1F,$1D,$1C,$1A,$18
   161 2130 17 16 14 13 12 11 + 	dta $17,$16,$14,$13,$12,$11,$10,$0F,$0E,$0D,$0C,$0B,$0A,$09,$08,$07
   162 2140			frqtabbass2
   163 2140 FF F1 E4 D8 CA C0 + 	dta $FF,$F1,$E4,$D8,$CA,$C0,$B5,$AB,$A2,$99,$8E,$87,$7F,$79,$73,$70
   164 2150 66 61 5A 55 52 4B + 	dta $66,$61,$5A,$55,$52,$4B,$48,$43,$3F,$3C,$39,$37,$33,$30,$2D,$2A
   165 2160 28 25 24 21 1F 1E + 	dta $28,$25,$24,$21,$1F,$1E,$1C,$1B,$19,$17,$16,$15,$13,$12,$11,$10
   166 2170 0F 0E 0D 0C 0B 0A + 	dta $0F,$0E,$0D,$0C,$0B,$0A,$09,$08,$07,$06,$05,$04,$03,$02,$01,$00
   167 2180			frqtabpure
   168 2180 F3 E6 D9 CC C1 B5 + 	dta $F3,$E6,$D9,$CC,$C1,$B5,$AD,$A2,$99,$90,$88,$80,$79,$72,$6C,$66
   169 2190 60 5B 55 51 4C 48 + 	dta $60,$5B,$55,$51,$4C,$48,$44,$40,$3C,$39,$35,$32,$2F,$2D,$2A,$28
   170 21A0 25 23 21 1F 1D 1C + 	dta $25,$23,$21,$1F,$1D,$1C,$1A,$18,$17,$16,$14,$13,$12,$11,$10,$0F
   171 21B0 0E 0D 0C 0B 0A 09 + 	dta $0E,$0D,$0C,$0B,$0A,$09,$08,$07,$06,$05,$04,$03,$02,$01,$00,$00
   172 					IFT FEAT_BASS16
   173 				frqtabbasshi
   174 					dta $0D,$0D,$0C,$0B,$0B,$0A,$0A,$09,$08,$08,$07,$07,$07,$06,$06,$05
   175 					dta $05,$05,$04,$04,$04,$04,$03,$03,$03,$03,$03,$02,$02,$02,$02,$02
   176 					dta $02,$02,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$00,$00
   177 					dta $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
   178 					EIF
   179 21C0					org PLAYER-$0100
   180 2200			volumetab
   181 2200-2665> 00 00 00 00 + 	dta $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
   182 2210 00 00 00 00 00 00 + 	dta $00,$00,$00,$00,$00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01
   183 2220 00 00 00 00 01 01 + 	dta $00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$02,$02,$02,$02
   184 2230 00 00 00 01 01 01 + 	dta $00,$00,$00,$01,$01,$01,$01,$01,$02,$02,$02,$02,$02,$03,$03,$03
   185 2240 00 00 01 01 01 01 + 	dta $00,$00,$01,$01,$01,$01,$02,$02,$02,$02,$03,$03,$03,$03,$04,$04
   186 2250 00 00 01 01 01 02 + 	dta $00,$00,$01,$01,$01,$02,$02,$02,$03,$03,$03,$04,$04,$04,$05,$05
   187 2260 00 00 01 01 02 02 + 	dta $00,$00,$01,$01,$02,$02,$02,$03,$03,$04,$04,$04,$05,$05,$06,$06
   188 2270 00 00 01 01 02 02 + 	dta $00,$00,$01,$01,$02,$02,$03,$03,$04,$04,$05,$05,$06,$06,$07,$07
   189 2280 00 01 01 02 02 03 + 	dta $00,$01,$01,$02,$02,$03,$03,$04,$04,$05,$05,$06,$06,$07,$07,$08
   190 2290 00 01 01 02 02 03 + 	dta $00,$01,$01,$02,$02,$03,$04,$04,$05,$05,$06,$07,$07,$08,$08,$09
   191 22A0 00 01 01 02 03 03 + 	dta $00,$01,$01,$02,$03,$03,$04,$05,$05,$06,$07,$07,$08,$09,$09,$0A
   192 22B0 00 01 01 02 03 04 + 	dta $00,$01,$01,$02,$03,$04,$04,$05,$06,$07,$07,$08,$09,$0A,$0A,$0B
   193 22C0 00 01 02 02 03 04 + 	dta $00,$01,$02,$02,$03,$04,$05,$06,$06,$07,$08,$09,$0A,$0A,$0B,$0C
   194 22D0 00 01 02 03 03 04 + 	dta $00,$01,$02,$03,$03,$04,$05,$06,$07,$08,$09,$0A,$0A,$0B,$0C,$0D
   195 22E0 00 01 02 03 04 05 + 	dta $00,$01,$02,$03,$04,$05,$06,$07,$07,$08,$09,$0A,$0B,$0C,$0D,$0E
   196 22F0 00 01 02 03 04 05 + 	dta $00,$01,$02,$03,$04,$05,$06,$07,$08,$09,$0A,$0B,$0C,$0D,$0E,$0F
   197 2300				org PLAYER
   198 				;*
   199 				;* Set of RMT main vectors:
   200 				;*
   201 2300			RASTERMUSICTRACKER
   202 2300 4C 12 23			jmp rmt_init
   203 2303 4C E2 24			jmp rmt_play
   204 2306 4C FC 24			jmp rmt_p3
   205 2309 4C 52 23			jmp rmt_silence
   206 230C 4C 30 26			jmp SetPokey
   207 					IFT FEAT_SFX
   208 230F 4C 65 24			jmp rmt_sfx			;* A=note(0,..,60),X=channel(0,..,3 or 0,..,7),Y=instrument*2(0,2,4,..,126)
   209 					EIF
   210 2312			rmt_init
   211 2312 86 D3			stx ns
   212 2314 84 D4			sty ns+1
   213 					IFT FEAT_NOSTARTINGSONGLINE==0
   214 2316 48				pha
   215 					EIF
   216 					IFT track_endvariables-track_variables>255
   217 					ldy #0
   218 					tya
   219 				ri0	sta track_variables,y
   220 					sta track_endvariables-$100,y
   221 					iny
   222 					bne ri0
   223 					ELS
   224 2317 A0 75			ldy #track_endvariables-track_variables
   225 2319 A9 00			lda #0
   226 231B 99 DF 1F		ri0	sta track_variables-1,y
   227 231E 88				dey
   228 231F D0 FA			bne ri0
   229 					EIF
   230 2321 A0 04			ldy #4
   231 2323 B1 D3			lda (ns),y
   232 2325 8D F0 24			sta v_maxtracklen
   233 2328 C8				iny
   234 					IFT FEAT_CONSTANTSPEED==0
   235 2329 B1 D3			lda (ns),y
   236 232B 8D B8 23			sta v_speed
   237 					EIF
   238 					IFT FEAT_INSTRSPEED==0
   239 					iny
   240 					lda (ns),y
   241 					sta v_instrspeed
   242 					sta v_ainstrspeed
   243 					ELI FEAT_INSTRSPEED>1
   244 					lda #FEAT_INSTRSPEED
   245 					sta v_ainstrspeed
   246 					EIF
   247 232E A0 08			ldy #8
   248 2330 B1 D3		ri1	lda (ns),y
   249 2332 99 C3 00			sta p_tis-8,y
   250 2335 C8				iny
   251 2336 C0 10			cpy #8+8
   252 2338 D0 F6			bne ri1
   253 					IFT FEAT_NOSTARTINGSONGLINE==0
   254 233A 68				pla
   255 233B 48				pha
   256 					IFT TRACKS>4
   257 					asl @
   258 					asl @
   259 					asl @
   260 					clc
   261 					adc p_song
   262 					sta p_song
   263 					pla
   264 					php
   265 					and #$e0
   266 					asl @
   267 					rol @
   268 					rol @
   269 					rol @
   270 					ELS
   271 233C 0A				asl @
   272 233D 0A				asl @
   273 233E 18				clc
   274 233F 65 D1			adc p_song
   275 2341 85 D1			sta p_song
   276 2343 68				pla
   277 2344 08				php
   278 2345 29 C0			and #$c0
   279 2347 0A				asl @
   280 2348 2A				rol @
   281 2349 2A				rol @
   282 					EIF
   283 234A 28				plp
   284 234B 65 D2			adc p_song+1
   285 234D 85 D2			sta p_song+1
   286 					EIF
   287 234F 20 67 23			jsr GetSongLineTrackLineInitOfNewSetInstrumentsOnlyRmtp3
   288 2352			rmt_silence
   289 					IFT STEREOMODE>0
   290 					lda #0
   291 					sta $d208
   292 					sta $d218
   293 					ldy #3
   294 					sty $d20f
   295 					sty $d21f
   296 					ldy #8
   297 				si1	sta $d200,y
   298 					sta $d210,y
   299 					dey
   300 					bpl si1
   301 					ELS
   302 2352 A9 00			lda #0
   303 2354 8D 08 D2			sta $d208
   304 2357 A0 03			ldy #3
   305 2359 8C 0F D2			sty $d20f
   306 235C A0 08			ldy #8
   307 235E 99 00 D2		si1	sta $d200,y
   308 2361 88				dey
   309 2362 10 FA			bpl si1
   310 					EIF
   311 					IFT FEAT_INSTRSPEED==0
   312 					lda v_instrspeed
   313 					ELS
   314 2364 A9 01			lda #FEAT_INSTRSPEED
   315 					EIF
   316 2366 60				rts
   317 2367			GetSongLineTrackLineInitOfNewSetInstrumentsOnlyRmtp3
   318 2367			GetSongLine
   319 2367 A2 00			ldx #0
   320 2369 8E EE 24			stx v_abeat
   321 236C			nn0
   322 236C 8A			nn1	txa
   323 236D A8				tay
   324 236E B1 D1			lda (p_song),y
   325 2370 C9 FE			cmp #$fe
   326 2372 B0 2D			bcs nn2
   327 2374 A8				tay
   328 2375 B1 CD			lda (p_trackslbstable),y
   329 2377 9D E0 1F			sta trackn_db,x
   330 237A B1 CF			lda (p_trackshbstable),y
   331 237C 9D E4 1F		nn1a sta trackn_hb,x
   332 237F A9 00			lda #0
   333 2381 9D E8 1F			sta trackn_idx,x
   334 2384 A9 01			lda #1
   335 2386 9D EC 1F		nn1a2 sta trackn_pause,x
   336 2389 A9 80			lda #$80
   337 238B 9D 00 20			sta trackn_instrx2,x
   338 238E E8				inx
   339 238F E0 04		xtracks01	cpx #TRACKS
   340 2391 D0 D9			bne nn1
   341 2393 A5 D1			lda p_song
   342 2395 18				clc
   343 2396 69 04		xtracks02	adc #TRACKS
   344 2398 85 D1			sta p_song
   345 239A 90 1B			bcc GetTrackLine
   346 239C E6 D2			inc p_song+1
   347 239E			nn1b
   348 239E 4C B7 23			jmp GetTrackLine
   349 23A1			nn2
   350 23A1 F0 04			beq nn3
   351 23A3			nn2a
   352 23A3 A9 00			lda #0
   353 23A5 F0 DF			beq nn1a2
   354 23A7			nn3
   355 23A7 A0 02			ldy #2
   356 23A9 B1 D1			lda (p_song),y
   357 23AB AA				tax
   358 23AC C8				iny
   359 23AD B1 D1			lda (p_song),y
   360 23AF 85 D2			sta p_song+1
   361 23B1 86 D1			stx p_song
   362 23B3 A2 00			ldx #0
   363 23B5 F0 B5			beq nn0
   364 23B7			GetTrackLine
   365 23B7			oo0
   366 23B7			oo0a
   367 					IFT FEAT_CONSTANTSPEED==0
   368 23B7 A9 FF			lda #$ff
   369 = 23B8			v_speed equ *-1
   370 23B9 8D 0B 24			sta v_bspeed
   371 					EIF
   372 23BC A2 FF			ldx #-1
   373 23BE			oo1
   374 23BE E8				inx
   375 23BF DE EC 1F			dec trackn_pause,x
   376 23C2 D0 42			bne oo1x
   377 23C4			oo1b
   378 23C4 BD E0 1F			lda trackn_db,x
   379 23C7 85 D3			sta ns
   380 23C9 BD E4 1F			lda trackn_hb,x
   381 23CC 85 D4			sta ns+1
   382 23CE			oo1i
   383 23CE BC E8 1F			ldy trackn_idx,x
   384 23D1 FE E8 1F			inc trackn_idx,x
   385 23D4 B1 D3			lda (ns),y
   386 23D6 85 D9			sta reg1
   387 23D8 29 3F			and #$3f
   388 23DA C9 3D			cmp #61
   389 23DC F0 0E			beq oo1a
   390 23DE B0 35			bcs oo2
   391 23E0 9D F0 1F			sta trackn_note,x
   392 					IFT FEAT_BASS16
   393 					sta trackn_outnote,x
   394 					EIF
   395 23E3 C8				iny
   396 23E4 B1 D3			lda (ns),y
   397 23E6 4A				lsr @
   398 23E7 29 7E			and #$3f*2
   399 23E9 9D 00 20			sta trackn_instrx2,x
   400 23EC			oo1a
   401 23EC A9 01			lda #1
   402 23EE 9D EC 1F			sta trackn_pause,x
   403 23F1 BC E8 1F			ldy trackn_idx,x
   404 23F4 FE E8 1F			inc trackn_idx,x
   405 23F7 B1 D3			lda (ns),y
   406 23F9 4A				lsr @
   407 23FA 66 D9			ror reg1
   408 23FC 4A				lsr @
   409 23FD 66 D9			ror reg1
   410 23FF A5 D9			lda reg1
   411 					IFT FEAT_GLOBALVOLUMEFADE
   412 					sec
   413 					sbc #$00
   414 				RMTGLOBALVOLUMEFADE equ *-1
   415 					bcs voig
   416 					lda #0
   417 				voig
   418 					EIF
   419 2401 29 F0			and #$f0
   420 2403 9D F4 1F			sta trackn_volume,x
   421 2406			oo1x
   422 2406 E0 03		xtracks03sub1	cpx #TRACKS-1
   423 2408 D0 B4			bne oo1
   424 					IFT FEAT_CONSTANTSPEED==0
   425 240A A9 FF			lda #$ff
   426 = 240B			v_bspeed equ *-1
   427 240C 8D B8 23			sta v_speed
   428 					ELS
   429 					lda #FEAT_CONSTANTSPEED
   430 					EIF
   431 240F 8D 54 20			sta v_aspeed
   432 2412 4C 5A 24			jmp InitOfNewSetInstrumentsOnly
   433 2415			oo2
   434 2415 C9 3F			cmp #63
   435 2417 F0 1B			beq oo63
   436 2419 A5 D9			lda reg1
   437 241B 29 C0			and #$c0
   438 241D F0 09			beq oo62_b
   439 241F 0A				asl @
   440 2420 2A				rol @
   441 2421 2A				rol @
   442 2422 9D EC 1F			sta trackn_pause,x
   443 2425 4C 06 24			jmp oo1x
   444 2428			oo62_b
   445 2428 C8				iny
   446 2429 B1 D3			lda (ns),y
   447 242B 9D EC 1F			sta trackn_pause,x
   448 242E FE E8 1F			inc trackn_idx,x
   449 2431 4C 06 24			jmp oo1x
   450 2434			oo63
   451 2434 A5 D9			lda reg1
   452 					IFT FEAT_CONSTANTSPEED==0
   453 2436 30 0C			bmi oo63_1X
   454 2438 C8				iny
   455 2439 B1 D3			lda (ns),y
   456 243B 8D 0B 24			sta v_bspeed
   457 243E FE E8 1F			inc trackn_idx,x
   458 2441 4C CE 23			jmp oo1i
   459 2444			oo63_1X
   460 					EIF
   461 2444 C9 FF			cmp #255
   462 2446 F0 09			beq oo63_11
   463 2448 C8				iny
   464 2449 B1 D3			lda (ns),y
   465 244B 9D E8 1F			sta trackn_idx,x
   466 244E 4C CE 23			jmp oo1i
   467 2451			oo63_11
   468 2451 4C 67 23			jmp GetSongLine
   469 2454 4C FC 24		p2xrmtp3	jmp rmt_p3
   470 2457 CA			p2x0 dex
   471 2458 30 FA			 bmi p2xrmtp3
   472 245A			InitOfNewSetInstrumentsOnly
   473 245A BC 00 20		p2x1 ldy trackn_instrx2,x
   474 245D 30 F8			bmi p2x0
   475 					IFT FEAT_SFX
   476 245F 20 6D 24			jsr SetUpInstrumentY2
   477 2462 4C 57 24			jmp p2x0
   478 2465			rmt_sfx
   479 2465 9D F0 1F			sta trackn_note,x
   480 					IFT FEAT_BASS16
   481 					sta trackn_outnote,x
   482 					EIF
   483 2468 A9 F0			lda #$f0				;* sfx note volume*16
   484 = 2469			RMTSFXVOLUME equ *-1		;* label for sfx note volume parameter overwriting
   485 246A 9D F4 1F			sta trackn_volume,x
   486 					EIF
   487 246D			SetUpInstrumentY2
   488 246D B1 CB			lda (p_instrstable),y
   489 246F 9D 04 20			sta trackn_instrdb,x
   490 2472 85 D7			sta nt
   491 2474 C8				iny
   492 2475 B1 CB			lda (p_instrstable),y
   493 2477 9D 08 20			sta trackn_instrhb,x
   494 247A 85 D8			sta nt+1
   495 					IFT FEAT_FILTER
   496 					lda #1
   497 					sta trackn_filter,x
   498 					EIF
   499 					IFT FEAT_TABLEGO
   500 					IFT FEAT_FILTER
   501 					tay
   502 					ELS
   503 247C A0 01			ldy #1
   504 					EIF
   505 247E B1 D7			lda (nt),y
   506 2480 9D 44 20			sta trackn_tablelop,x
   507 2483 C8				iny
   508 					ELS
   509 					ldy #2
   510 					EIF
   511 2484 B1 D7			lda (nt),y
   512 2486 9D 10 20			sta trackn_instrlen,x
   513 2489 C8				iny
   514 248A B1 D7			lda (nt),y
   515 248C 9D 14 20			sta trackn_instrlop,x
   516 248F C8				iny
   517 2490 B1 D7			lda (nt),y
   518 2492 9D 34 20			sta trackn_tabletypespeed,x
   519 					IFT FEAT_TABLETYPE||FEAT_TABLEMODE
   520 					and #$3f
   521 					EIF
   522 2495 9D 48 20			sta trackn_tablespeeda,x
   523 					IFT FEAT_TABLEMODE
   524 					lda (nt),y
   525 					and #$40
   526 					sta trackn_tablemode,x
   527 					EIF
   528 					IFT FEAT_AUDCTLMANUALSET
   529 					iny
   530 					lda (nt),y
   531 					sta trackn_audctl,x
   532 					iny
   533 					ELS
   534 2498 A0 06			ldy #6
   535 					EIF
   536 249A B1 D7			lda (nt),y
   537 249C 9D 1C 20			sta trackn_volumeslidedepth,x
   538 					IFT FEAT_VOLUMEMIN
   539 249F C8				iny
   540 24A0 B1 D7			lda (nt),y
   541 24A2 9D 24 20			sta trackn_volumemin,x
   542 					IFT FEAT_EFFECTS
   543 24A5 C8				iny
   544 					EIF
   545 					ELS
   546 					IFT FEAT_EFFECTS
   547 					ldy #8
   548 					EIF
   549 					EIF
   550 					IFT FEAT_EFFECTS
   551 24A6 B1 D7			lda (nt),y
   552 24A8 9D 28 20			sta trackn_effdelay,x
   553 					IFT FEAT_EFFECTVIBRATO
   554 24AB C8				iny
   555 24AC B1 D7			lda (nt),y
   556 24AE A8				tay
   557 24AF B9 92 20			lda vibtabbeg,y
   558 24B2 9D 2C 20			sta trackn_effvibratoa,x
   559 					EIF
   560 					IFT FEAT_EFFECTFSHIFT
   561 24B5 A0 0A			ldy #10
   562 24B7 B1 D7			lda (nt),y
   563 24B9 9D 30 20			sta trackn_effshift,x
   564 					EIF
   565 					EIF
   566 24BC A9 80			lda #128
   567 24BE 9D 20 20			sta trackn_volumeslidevalue,x
   568 24C1 9D 00 20			sta trackn_instrx2,x
   569 24C4 0A				asl @
   570 24C5 9D 18 20			sta trackn_instrreachend,x
   571 24C8 9D FC 1F			sta trackn_shiftfrq,x
   572 24CB A8				tay
   573 24CC B1 D7			lda (nt),y
   574 24CE 9D 40 20			sta trackn_tableend,x
   575 24D1 69 00			adc #0
   576 24D3 9D 0C 20			sta trackn_instridx,x
   577 24D6 A9 0C			lda #INSTRPAR
   578 24D8 9D 3C 20			sta trackn_tablea,x
   579 24DB A8				tay
   580 24DC B1 D7			lda (nt),y
   581 24DE 9D 38 20			sta trackn_tablenote,x
   582 24E1			xata_rtshere
   583 					IFT FEAT_SFX
   584 24E1 60				rts
   585 					ELS
   586 					jmp p2x0
   587 					EIF
   588 24E2			rmt_play
   589 24E2			rmt_p0
   590 24E2 20 30 26			jsr SetPokey
   591 24E5			rmt_p1
   592 					IFT FEAT_INSTRSPEED==0||FEAT_INSTRSPEED>1
   593 					dec v_ainstrspeed
   594 					bne rmt_p3
   595 					EIF
   596 					IFT FEAT_INSTRSPEED==0
   597 					lda #$ff
   598 				v_instrspeed	equ *-1
   599 					sta v_ainstrspeed
   600 					ELI FEAT_INSTRSPEED>1
   601 					lda #FEAT_INSTRSPEED
   602 					sta v_ainstrspeed
   603 					EIF
   604 24E5			rmt_p2
   605 24E5 CE 54 20			dec v_aspeed
   606 24E8 D0 12			bne rmt_p3
   607 24EA EE EE 24			inc v_abeat
   608 24ED A9 FF			lda #$ff
   609 = 24EE			v_abeat equ *-1
   610 24EF C9 FF			cmp #$ff
   611 = 24F0			v_maxtracklen equ *-1
   612 24F1 F0 03			beq p2o3
   613 24F3 4C B7 23			jmp GetTrackLine
   614 24F6			p2o3
   615 24F6 4C 67 23			jmp GetSongLineTrackLineInitOfNewSetInstrumentsOnlyRmtp3
   616 24F9 4C 1F 26		go_ppnext	jmp ppnext
   617 24FC			rmt_p3
   618 24FC A9 21			lda #>frqtab
   619 24FE 85 D6			sta nr+1
   620 2500 A2 03		xtracks05sub1	ldx #TRACKS-1
   621 2502			pp1
   622 2502 BD 08 20			lda trackn_instrhb,x
   623 2505 F0 F2			beq go_ppnext
   624 2507 85 D4			sta ns+1
   625 2509 BD 04 20			lda trackn_instrdb,x
   626 250C 85 D3			sta ns
   627 250E BC 0C 20			ldy trackn_instridx,x
   628 2511 B1 D3			lda (ns),y
   629 2513 85 D9			sta reg1
   630 2515 C8				iny
   631 2516 B1 D3			lda (ns),y
   632 2518 85 DA			sta reg2
   633 251A C8				iny
   634 251B B1 D3			lda (ns),y
   635 251D 85 DB			sta reg3
   636 251F C8				iny
   637 2520 98				tya
   638 2521 DD 10 20			cmp trackn_instrlen,x
   639 2524 90 0A			bcc pp2
   640 2526 F0 08			beq pp2
   641 2528 A9 80			lda #$80
   642 252A 9D 18 20			sta trackn_instrreachend,x
   643 252D			pp1b
   644 252D BD 14 20			lda trackn_instrlop,x
   645 2530 9D 0C 20		pp2	sta trackn_instridx,x
   646 2533 A5 D9			lda reg1
   647 					IFT TRACKS>4
   648 					cpx #4
   649 					bcc pp2s
   650 					lsr @
   651 					lsr @
   652 					lsr @
   653 					lsr @
   654 				pp2s
   655 					EIF
   656 2535 29 0F			and #$0f
   657 2537 1D F4 1F			ora trackn_volume,x
   658 253A A8				tay
   659 253B B9 00 22			lda volumetab,y
   660 253E 85 DC			sta tmp
   661 2540 A5 DA			lda reg2
   662 2542 29 0E			and #$0e
   663 2544 A8				tay
   664 2545 B9 82 20			lda tabbeganddistor,y
   665 2548 85 D5			sta nr
   666 254A A5 DC			lda tmp
   667 254C 19 83 20			ora tabbeganddistor+1,y
   668 254F 9D 50 20			sta trackn_audc,x
   669 2552			InstrumentsEffects
   670 					IFT FEAT_EFFECTS
   671 2552 BD 28 20			lda trackn_effdelay,x
   672 2555 F0 21			beq ei2
   673 2557 C9 01			cmp #1
   674 2559 D0 1A			bne ei1
   675 255B BD FC 1F			lda trackn_shiftfrq,x
   676 					IFT FEAT_EFFECTFSHIFT
   677 255E 18				clc
   678 255F 7D 30 20			adc trackn_effshift,x
   679 					EIF
   680 					IFT FEAT_EFFECTVIBRATO
   681 2562 18				clc
   682 2563 BC 2C 20			ldy trackn_effvibratoa,x
   683 2566 79 96 20			adc vib0,y
   684 					EIF
   685 2569 9D FC 1F			sta trackn_shiftfrq,x
   686 					IFT FEAT_EFFECTVIBRATO
   687 256C B9 AB 20			lda vibtabnext,y
   688 256F 9D 2C 20			sta trackn_effvibratoa,x
   689 					EIF
   690 2572 4C 78 25			jmp ei2
   691 2575			ei1
   692 2575 DE 28 20			dec trackn_effdelay,x
   693 2578			ei2
   694 					EIF
   695 2578 BC 40 20			ldy trackn_tableend,x
   696 257B C0 0D			cpy #INSTRPAR+1
   697 257D 90 31			bcc ei3
   698 257F BD 48 20			lda trackn_tablespeeda,x
   699 2582 10 26			bpl ei2f
   700 2584			ei2c
   701 2584 98				tya
   702 2585 DD 3C 20			cmp trackn_tablea,x
   703 2588 D0 08			bne ei2c2
   704 					IFT FEAT_TABLEGO
   705 258A BD 44 20			lda trackn_tablelop,x
   706 					ELS
   707 					lda #INSTRPAR
   708 					EIF
   709 258D 9D 3C 20			sta trackn_tablea,x
   710 2590 D0 03			bne ei2a
   711 2592			ei2c2
   712 2592 FE 3C 20			inc trackn_tablea,x
   713 2595			ei2a
   714 2595 BD 04 20			lda trackn_instrdb,x
   715 2598 85 D7			sta nt
   716 259A BD 08 20			lda trackn_instrhb,x
   717 259D 85 D8			sta nt+1
   718 259F BC 3C 20			ldy trackn_tablea,x
   719 25A2 B1 D7			lda (nt),y
   720 					IFT FEAT_TABLEMODE
   721 					ldy trackn_tablemode,x
   722 					beq ei2e
   723 					clc
   724 					adc trackn_tablenote,x
   725 				ei2e
   726 					EIF
   727 25A4 9D 38 20			sta trackn_tablenote,x
   728 25A7 BD 34 20			lda trackn_tabletypespeed,x
   729 					IFT FEAT_TABLETYPE||FEAT_TABLEMODE
   730 					and #$3f
   731 					EIF
   732 25AA			ei2f
   733 25AA 38				sec
   734 25AB E9 01			sbc #1
   735 25AD 9D 48 20			sta trackn_tablespeeda,x
   736 25B0			ei3
   737 25B0 BD 18 20			lda trackn_instrreachend,x
   738 25B3 10 1F			bpl ei4
   739 25B5 BD F4 1F			lda trackn_volume,x
   740 25B8 F0 1A			beq ei4
   741 					IFT FEAT_VOLUMEMIN
   742 25BA DD 24 20			cmp trackn_volumemin,x
   743 25BD F0 15			beq ei4
   744 25BF 90 13			bcc ei4
   745 					EIF
   746 25C1 A8				tay
   747 25C2 BD 20 20			lda trackn_volumeslidevalue,x
   748 25C5 18				clc
   749 25C6 7D 1C 20			adc trackn_volumeslidedepth,x
   750 25C9 9D 20 20			sta trackn_volumeslidevalue,x
   751 25CC 90 06			bcc ei4
   752 25CE 98				tya
   753 25CF E9 10			sbc #16
   754 25D1 9D F4 1F			sta trackn_volume,x
   755 25D4			ei4
   756 					IFT FEAT_COMMAND2
   757 25D4 A9 00			lda #0
   758 25D6 85 DD			sta frqaddcmd2
   759 					EIF
   760 					IFT FEAT_COMMAND1||FEAT_COMMAND2||FEAT_COMMAND3||FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   761 25D8 A5 DA			lda reg2
   762 					IFT FEAT_FILTER||FEAT_BASS16
   763 					sta trackn_command,x
   764 					EIF
   765 25DA 29 70			and #$70
   766 					IFT 1==[FEAT_COMMAND1+FEAT_COMMAND2+FEAT_COMMAND3+FEAT_COMMAND4+FEAT_COMMAND5+FEAT_COMMAND6+[FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY]]
   767 					beq cmd0
   768 					ELS
   769 25DC 4A				lsr @
   770 25DD 4A				lsr @
   771 25DE 8D E2 25			sta jmx+1
   772 25E1 90 FE		jmx	bcc *
   773 25E3 4C FD 25			jmp cmd0
   774 25E6 EA				nop
   775 25E7 4C EE 25			jmp cmd1
   776 					IFT FEAT_COMMAND2||FEAT_COMMAND3||FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   777 25EA EA				nop
   778 25EB 4C F3 25			jmp cmd2
   779 					EIF
   780 					IFT FEAT_COMMAND3||FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   781 					nop
   782 					jmp cmd3
   783 					EIF
   784 					IFT FEAT_COMMAND4||FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   785 					nop
   786 					jmp cmd4
   787 					EIF
   788 					IFT FEAT_COMMAND5||FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   789 					nop
   790 					jmp cmd5
   791 					EIF
   792 					IFT FEAT_COMMAND6||FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   793 					nop
   794 					jmp cmd6
   795 					EIF
   796 					IFT FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   797 					nop
   798 					jmp cmd7
   799 					EIF
   800 					EIF
   801 					ELS
   802 					IFT FEAT_FILTER||FEAT_BASS16
   803 					lda reg2
   804 					sta trackn_command,x
   805 					EIF
   806 					EIF
   807 25EE			cmd1
   808 					IFT FEAT_COMMAND1
   809 25EE A5 DB			lda reg3
   810 25F0 4C 1C 26			jmp cmd0c
   811 					EIF
   812 25F3			cmd2
   813 					IFT FEAT_COMMAND2
   814 25F3 A5 DB			lda reg3
   815 25F5 85 DD			sta frqaddcmd2
   816 25F7 BD F0 1F			lda trackn_note,x
   817 25FA 4C 03 26			jmp cmd0a
   818 					EIF
   819 25FD			cmd3
   820 					IFT FEAT_COMMAND3
   821 					lda trackn_note,x
   822 					clc
   823 					adc reg3
   824 					sta trackn_note,x
   825 					jmp cmd0a
   826 					EIF
   827 25FD			cmd4
   828 					IFT FEAT_COMMAND4
   829 					lda trackn_shiftfrq,x
   830 					clc
   831 					adc reg3
   832 					sta trackn_shiftfrq,x
   833 					lda trackn_note,x
   834 					jmp cmd0a
   835 					EIF
   836 25FD			cmd5
   837 					IFT FEAT_COMMAND5&&FEAT_PORTAMENTO
   838 					IFT FEAT_TABLETYPE
   839 					lda trackn_tabletypespeed,x
   840 					bpl cmd5a1
   841 					ldy trackn_note,x
   842 					lda (nr),y
   843 					clc
   844 					adc trackn_tablenote,x
   845 					jmp cmd5ax
   846 					EIF
   847 				cmd5a1
   848 					lda trackn_note,x
   849 					clc
   850 					adc trackn_tablenote,x
   851 					cmp #61
   852 					bcc cmd5a2
   853 					lda #63
   854 				cmd5a2
   855 					tay
   856 					lda (nr),y
   857 				cmd5ax
   858 					sta trackn_portafrqc,x
   859 					ldy reg3
   860 					bne cmd5a
   861 					sta trackn_portafrqa,x
   862 				cmd5a
   863 					tya
   864 					lsr @
   865 					lsr @
   866 					lsr @
   867 					lsr @
   868 					sta trackn_portaspeed,x
   869 					sta trackn_portaspeeda,x
   870 					lda reg3
   871 					and #$0f
   872 					sta trackn_portadepth,x
   873 					lda trackn_note,x
   874 					jmp cmd0a
   875 					ELI FEAT_COMMAND5
   876 					lda trackn_note,x
   877 					jmp cmd0a
   878 					EIF
   879 25FD			cmd6
   880 					IFT FEAT_COMMAND6&&FEAT_FILTER
   881 					lda reg3
   882 					clc
   883 					adc trackn_filter,x
   884 					sta trackn_filter,x
   885 					lda trackn_note,x
   886 					jmp cmd0a
   887 					ELI FEAT_COMMAND6
   888 					lda trackn_note,x
   889 					jmp cmd0a
   890 					EIF
   891 25FD			cmd7
   892 					IFT FEAT_COMMAND7SETNOTE||FEAT_COMMAND7VOLUMEONLY
   893 					IFT FEAT_COMMAND7SETNOTE
   894 					lda reg3
   895 					IFT FEAT_COMMAND7VOLUMEONLY
   896 					cmp #$80
   897 					beq cmd7a
   898 					EIF
   899 					sta trackn_note,x
   900 					jmp cmd0a
   901 					EIF
   902 					IFT FEAT_COMMAND7VOLUMEONLY
   903 				cmd7a
   904 					lda trackn_audc,x
   905 					ora #$f0
   906 					sta trackn_audc,x
   907 					lda trackn_note,x
   908 					jmp cmd0a
   909 					EIF
   910 					EIF
   911 25FD			cmd0
   912 25FD BD F0 1F			lda trackn_note,x
   913 2600 18				clc
   914 2601 65 DB			adc reg3
   915 2603			cmd0a
   916 					IFT FEAT_TABLETYPE
   917 					ldy trackn_tabletypespeed,x
   918 					bmi cmd0b
   919 					EIF
   920 2603 18				clc
   921 2604 7D 38 20			adc trackn_tablenote,x
   922 2607 C9 3D			cmp #61
   923 2609 90 07			bcc cmd0a1
   924 260B A9 00			lda #0
   925 260D 9D 50 20			sta trackn_audc,x
   926 2610 A9 3F			lda #63
   927 2612			cmd0a1
   928 					IFT FEAT_BASS16
   929 					sta trackn_outnote,x
   930 					EIF
   931 2612 A8				tay
   932 2613 B1 D5			lda (nr),y
   933 2615 18				clc
   934 2616 7D FC 1F			adc trackn_shiftfrq,x
   935 					IFT FEAT_COMMAND2
   936 2619 18				clc
   937 261A 65 DD			adc frqaddcmd2
   938 					EIF
   939 					IFT FEAT_TABLETYPE
   940 					jmp cmd0c
   941 				cmd0b
   942 					cmp #61
   943 					bcc cmd0b1
   944 					lda #0
   945 					sta trackn_audc,x
   946 					lda #63
   947 				cmd0b1
   948 					tay
   949 					lda trackn_shiftfrq,x
   950 					clc
   951 					adc trackn_tablenote,x
   952 					clc
   953 					adc (nr),y
   954 					IFT FEAT_COMMAND2
   955 					clc
   956 					adc frqaddcmd2
   957 					EIF
   958 					EIF
   959 261C			cmd0c
   960 261C 9D 4C 20			sta trackn_audf,x
   961 261F			pp9
   962 					IFT FEAT_PORTAMENTO
   963 					lda trackn_portaspeeda,x
   964 					beq pp10
   965 					dec trackn_portaspeeda,x
   966 					bne pp10
   967 					lda trackn_portaspeed,x
   968 					sta trackn_portaspeeda,x
   969 					lda trackn_portafrqa,x
   970 					cmp trackn_portafrqc,x
   971 					beq pp10
   972 					bcs pps1
   973 					adc trackn_portadepth,x
   974 					bcs pps8
   975 					cmp trackn_portafrqc,x
   976 					bcs pps8
   977 					jmp pps9
   978 				pps1
   979 					sbc trackn_portadepth,x
   980 					bcc pps8
   981 					cmp trackn_portafrqc,x
   982 					bcs pps9
   983 				pps8
   984 					lda trackn_portafrqc,x
   985 				pps9
   986 					sta trackn_portafrqa,x
   987 				pp10
   988 					lda reg2
   989 					and #$01
   990 					beq pp11
   991 					lda trackn_portafrqa,x
   992 					clc
   993 					adc trackn_shiftfrq,x
   994 					sta trackn_audf,x
   995 				pp11
   996 					EIF
   997 261F			ppnext
   998 261F CA				dex
   999 2620 30 03			bmi rmt_p4
  1000 2622 4C 02 25			jmp pp1
  1001 2625			rmt_p4
  1002 					IFT FEAT_AUDCTLMANUALSET
  1003 					lda trackn_audctl+0
  1004 					ora trackn_audctl+1
  1005 					ora trackn_audctl+2
  1006 					ora trackn_audctl+3
  1007 					tax
  1008 					ELS
  1009 2625 A2 00			ldx #0
  1010 					EIF
  1011 2627			qq1
  1012 2627 8E 31 26			stx v_audctl
  1013 					IFT FEAT_FILTER
  1014 					IFT FEAT_FILTERG0L
  1015 					lda trackn_command+0
  1016 					bpl qq2
  1017 					lda trackn_audc+0
  1018 					and #$0f
  1019 					beq qq2
  1020 					lda trackn_audf+0
  1021 					clc
  1022 					adc trackn_filter+0
  1023 					sta trackn_audf+2
  1024 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2L
  1025 					lda trackn_audc+2
  1026 					and #$10
  1027 					bne qq1a
  1028 					EIF
  1029 					lda #0
  1030 					sta trackn_audc+2
  1031 				qq1a
  1032 					txa
  1033 					ora #4
  1034 					tax
  1035 					EIF
  1036 				qq2
  1037 					IFT FEAT_FILTERG1L
  1038 					lda trackn_command+1
  1039 					bpl qq3
  1040 					lda trackn_audc+1
  1041 					and #$0f
  1042 					beq qq3
  1043 					lda trackn_audf+1
  1044 					clc
  1045 					adc trackn_filter+1
  1046 					sta trackn_audf+3
  1047 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG3L
  1048 					lda trackn_audc+3
  1049 					and #$10
  1050 					bne qq2a
  1051 					EIF
  1052 					lda #0
  1053 					sta trackn_audc+3
  1054 				qq2a
  1055 					txa
  1056 					ora #2
  1057 					tax
  1058 					EIF
  1059 				qq3
  1060 					IFT FEAT_FILTERG0L||FEAT_FILTERG1L
  1061 					cpx v_audctl
  1062 					bne qq5
  1063 					EIF
  1064 					EIF
  1065 					IFT FEAT_BASS16
  1066 					IFT FEAT_BASS16G1L
  1067 					lda trackn_command+1
  1068 					and #$0e
  1069 					cmp #6
  1070 					bne qq4
  1071 					lda trackn_audc+1
  1072 					and #$0f
  1073 					beq qq4
  1074 					ldy trackn_outnote+1
  1075 					lda frqtabbasslo,y
  1076 					sta trackn_audf+0
  1077 					lda frqtabbasshi,y
  1078 					sta trackn_audf+1
  1079 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG0L
  1080 					lda trackn_audc+0
  1081 					and #$10
  1082 					bne qq3a
  1083 					EIF
  1084 					lda #0
  1085 					sta trackn_audc+0
  1086 				qq3a
  1087 					txa
  1088 					ora #$50
  1089 					tax
  1090 					EIF
  1091 				qq4
  1092 					IFT FEAT_BASS16G3L
  1093 					lda trackn_command+3
  1094 					and #$0e
  1095 					cmp #6
  1096 					bne qq5
  1097 					lda trackn_audc+3
  1098 					and #$0f
  1099 					beq qq5
  1100 					ldy trackn_outnote+3
  1101 					lda frqtabbasslo,y
  1102 					sta trackn_audf+2
  1103 					lda frqtabbasshi,y
  1104 					sta trackn_audf+3
  1105 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2L
  1106 					lda trackn_audc+2
  1107 					and #$10
  1108 					bne qq4a
  1109 					EIF
  1110 					lda #0
  1111 					sta trackn_audc+2
  1112 				qq4a
  1113 					txa
  1114 					ora #$28
  1115 					tax
  1116 					EIF
  1117 					EIF
  1118 262A			qq5
  1119 262A 8E 31 26			stx v_audctl
  1120 					IFT TRACKS>4
  1121 					IFT FEAT_AUDCTLMANUALSET
  1122 					lda trackn_audctl+4
  1123 					ora trackn_audctl+5
  1124 					ora trackn_audctl+6
  1125 					ora trackn_audctl+7
  1126 					tax
  1127 					ELS
  1128 					ldx #0
  1129 					EIF
  1130 					stx v_audctl2
  1131 					IFT FEAT_FILTER
  1132 					IFT FEAT_FILTERG0R
  1133 					lda trackn_command+0+4
  1134 					bpl qs2
  1135 					lda trackn_audc+0+4
  1136 					and #$0f
  1137 					beq qs2
  1138 					lda trackn_audf+0+4
  1139 					clc
  1140 					adc trackn_filter+0+4
  1141 					sta trackn_audf+2+4
  1142 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2R
  1143 					lda trackn_audc+2+4
  1144 					and #$10
  1145 					bne qs1a
  1146 					EIF
  1147 					lda #0
  1148 					sta trackn_audc+2+4
  1149 				qs1a
  1150 					txa
  1151 					ora #4
  1152 					tax
  1153 					EIF
  1154 				qs2
  1155 					IFT FEAT_FILTERG1R
  1156 					lda trackn_command+1+4
  1157 					bpl qs3
  1158 					lda trackn_audc+1+4
  1159 					and #$0f
  1160 					beq qs3
  1161 					lda trackn_audf+1+4
  1162 					clc
  1163 					adc trackn_filter+1+4
  1164 					sta trackn_audf+3+4
  1165 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG3R
  1166 					lda trackn_audc+3+4
  1167 					and #$10
  1168 					bne qs2a
  1169 					EIF
  1170 					lda #0
  1171 					sta trackn_audc+3+4
  1172 				qs2a
  1173 					txa
  1174 					ora #2
  1175 					tax
  1176 					EIF
  1177 				qs3
  1178 					IFT FEAT_FILTERG0R||FEAT_FILTERG1R
  1179 					cpx v_audctl2
  1180 					bne qs5
  1181 					EIF
  1182 					EIF
  1183 					IFT FEAT_BASS16
  1184 					IFT FEAT_BASS16G1R
  1185 					lda trackn_command+1+4
  1186 					and #$0e
  1187 					cmp #6
  1188 					bne qs4
  1189 					lda trackn_audc+1+4
  1190 					and #$0f
  1191 					beq qs4
  1192 					ldy trackn_outnote+1+4
  1193 					lda frqtabbasslo,y
  1194 					sta trackn_audf+0+4
  1195 					lda frqtabbasshi,y
  1196 					sta trackn_audf+1+4
  1197 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG0R
  1198 					lda trackn_audc+0+4
  1199 					and #$10
  1200 					bne qs3a
  1201 					EIF
  1202 					lda #0
  1203 					sta trackn_audc+0+4
  1204 				qs3a
  1205 					txa
  1206 					ora #$50
  1207 					tax
  1208 					EIF
  1209 				qs4
  1210 					IFT FEAT_BASS16G3R
  1211 					lda trackn_command+3+4
  1212 					and #$0e
  1213 					cmp #6
  1214 					bne qs5
  1215 					lda trackn_audc+3+4
  1216 					and #$0f
  1217 					beq qs5
  1218 					ldy trackn_outnote+3+4
  1219 					lda frqtabbasslo,y
  1220 					sta trackn_audf+2+4
  1221 					lda frqtabbasshi,y
  1222 					sta trackn_audf+3+4
  1223 					IFT FEAT_COMMAND7VOLUMEONLY&&FEAT_VOLUMEONLYG2R
  1224 					lda trackn_audc+2+4
  1225 					and #$10
  1226 					bne qs4a
  1227 					EIF
  1228 					lda #0
  1229 					sta trackn_audc+2+4
  1230 				qs4a
  1231 					txa
  1232 					ora #$28
  1233 					tax
  1234 					EIF
  1235 					EIF
  1236 				qs5
  1237 					stx v_audctl2
  1238 					EIF
  1239 262D			rmt_p5
  1240 					IFT FEAT_INSTRSPEED==0||FEAT_INSTRSPEED>1
  1241 					lda #$ff
  1242 				v_ainstrspeed equ *-1
  1243 					ELS
  1244 262D A9 01			lda #1
  1245 					EIF
  1246 262F 60				rts
  1247 2630			SetPokey
  1248 					IFT STEREOMODE==1		;* L1 L2 L3 L4 R1 R2 R3 R4
  1249 					ldy #$ff
  1250 				v_audctl2 equ *-1
  1251 					lda trackn_audf+0+4
  1252 					ldx trackn_audf+0
  1253 				xstastx01	sta $d210
  1254 					stx $d200
  1255 					lda trackn_audc+0+4
  1256 					ldx trackn_audc+0
  1257 				xstastx02	sta $d211
  1258 					stx $d201
  1259 					lda trackn_audf+1+4
  1260 					ldx trackn_audf+1
  1261 				xstastx03	sta $d212
  1262 					stx $d202
  1263 					lda trackn_audc+1+4
  1264 					ldx trackn_audc+1
  1265 				xstastx04	sta $d213
  1266 					stx $d203
  1267 					lda trackn_audf+2+4
  1268 					ldx trackn_audf+2
  1269 				xstastx05	sta $d214
  1270 					stx $d204
  1271 					lda trackn_audc+2+4
  1272 					ldx trackn_audc+2
  1273 				xstastx06	sta $d215
  1274 					stx $d205
  1275 					lda trackn_audf+3+4
  1276 					ldx trackn_audf+3
  1277 				xstastx07	sta $d216
  1278 					stx $d206
  1279 					lda trackn_audc+3+4
  1280 					ldx trackn_audc+3
  1281 				xstastx08	sta $d217
  1282 					stx $d207
  1283 					lda #$ff
  1284 				v_audctl equ *-1
  1285 				xstysta01	sty $d218
  1286 					sta $d208
  1287 					ELI STEREOMODE==0		;* L1 L2 L3 L4
  1288 2630 A0 FF			ldy #$ff
  1289 = 2631			v_audctl equ *-1
  1290 2632 AD 4C 20			lda trackn_audf+0
  1291 2635 AE 50 20			ldx trackn_audc+0
  1292 2638 8D 00 D2			sta $d200
  1293 263B 8E 01 D2			stx $d201
  1294 263E AD 4D 20			lda trackn_audf+1
  1295 2641 AE 51 20			ldx trackn_audc+1
  1296 2644 8D 02 D2			sta $d200+2
  1297 2647 8E 03 D2			stx $d201+2
  1298 264A AD 4E 20			lda trackn_audf+2
  1299 264D AE 52 20			ldx trackn_audc+2
  1300 2650 8D 04 D2			sta $d200+4
  1301 2653 8E 05 D2			stx $d201+4
  1302 2656 AD 4F 20			lda trackn_audf+3
  1303 2659 AE 53 20			ldx trackn_audc+3
  1304 265C 8D 06 D2			sta $d200+6
  1305 265F 8E 07 D2			stx $d201+6
  1306 2662 8C 08 D2			sty $d208
  1307 					ELI STEREOMODE==2		;* L1 R2 R3 L4
  1308 					ldy #$ff
  1309 				v_audctl equ *-1
  1310 					lda trackn_audf+0
  1311 					ldx trackn_audc+0
  1312 					sta $d200
  1313 					stx $d201
  1314 					sta $d210
  1315 					lda trackn_audf+1
  1316 					ldx trackn_audc+1
  1317 					sta $d210+2
  1318 					stx $d211+2
  1319 					lda trackn_audf+2
  1320 					ldx trackn_audc+2
  1321 					sta $d210+4
  1322 					stx $d211+4
  1323 					sta $d200+4
  1324 					lda trackn_audf+3
  1325 					ldx trackn_audc+3
  1326 					sta $d200+6
  1327 					stx $d201+6
  1328 					sta $d210+6
  1329 					sty $d218
  1330 					sty $d208
  1331 					ELI STEREOMODE==3		;* L1 L2 R3 R4
  1332 					ldy #$ff
  1333 				v_audctl equ *-1
  1334 					lda trackn_audf+0
  1335 					ldx trackn_audc+0
  1336 					sta $d200
  1337 					stx $d201
  1338 					lda trackn_audf+1
  1339 					ldx trackn_audc+1
  1340 					sta $d200+2
  1341 					stx $d201+2
  1342 					lda trackn_audf+2
  1343 					ldx trackn_audc+2
  1344 					sta $d210+4
  1345 					stx $d211+4
  1346 					sta $d200+4
  1347 					lda trackn_audf+3
  1348 					ldx trackn_audc+3
  1349 					sta $d210+6
  1350 					stx $d211+6
  1351 					sta $d200+6
  1352 					sty $d218
  1353 					sty $d208
  1354 					EIF
  1355 2665 60				rts
  1356 2666			RMTPLAYEREND
    14 				;
    15 				;
    16 					opt h-						;RMT module is standard Atari binary file already
    17 2666 FF FF 00 27 47 49 + 	ins "sfx.rmt"				;include music RMT module
    18 					opt h+
    19 				;
    20 				;
    21 				;
    22 48B4				org SFX_CODE 
    23 4950			start
    24 4950-49E4> A9 F0			lda #$F0					;initial value
    25 4952 8D 69 24			sta RMTSFXVOLUME			;sfx note volume * 16 (0,16,32,...,240)
    26 				;
    27 4955 A9 FF			lda #$ff					;initial value
    28 4957 8D DE 49			sta sfx_effect
    29 				;
    30 495A A2 00			ldx #<MODUL					;low byte of RMT module to X reg
    31 495C A0 27			ldy #>MODUL					;hi byte of RMT module to Y reg
    32 495E AD DF 49			lda track_to_play
    33 4961 20 00 23			jsr RASTERMUSICTRACKER		;Init
    34
    35 				; SET VBI
    36 4964 AC E2 49			ldy vbi_address
    37 4967 AE E3 49			ldx vbi_address+1
    38 496A A9 07			lda #$07
    39 496C 20 5C E4			jsr $e45c					;Start VBI routine
    40 496F 60				rts
    41 					
    42 4970			new_init                        ; Set VBI address depending on the NTSC or PAL	
    43 4970 78				 sei
    44 4971 AD 0B D4		loop lda $D40B; vcount
    45 4974 CD 0B D4		     cmp $D40B; vcount
    46 4977 F0 FB		     beq *-3
    47 4979 90 F6		     bcc loop
    48 497B C9 83		     cmp #131 ;; BCC #132
    49 497D 58				 cli
    50 497E B0 0A		     BCS finish_init ; PAL
    51 					 ;ntsc
    52 4980 A9 A3			 lda #<ntsc_vbi   ; low byte
    53 4982 8D E2 49			 sta vbi_address ; low
    54 4985 A9 49			 lda #>ntsc_vbi   ; hi byte
    55 4987 8D E3 49			 sta vbi_address+1 ; hi
    56 498A			finish_init
    57 498A AD 24 02 8D DC 49 + 	 mwa $224 old_vbi			; Store old VBI
    58 4996 60				 rts
    59 				;
    60
    61 				; restore old VBI routine
    62 4997			stop    
    63 4997 AC DC 49			ldy old_vbi
    64 499A AE DD 49			ldx old_vbi+1
    65 499D A9 07			lda #$07
    66 499F 20 5C E4			jsr $e45c					;Start VBI routine
    67 49A2 60			    rts
    68 				;
    69
    70 49A3			ntsc_vbi
    71 49A3 CE E1 49			dec	ntsc_counter
    72 49A6 D0 08			bne	vbi
    73 49A8 A9 05			lda #5
    74 49AA 8D E1 49			sta ntsc_counter	
    75 49AD 4C D9 49		    jmp end_vbi
    76
    77 49B0			vbi
    78 49B0 AD E4 49 C9 00 90 + 	#if .byte vbi_counter > #0 
    79 49B9 CE E4 49				dec vbi_counter
    80 49BC				#end
    81
    82 49BC AD E0 49		    lda music_plays
    83 49BF C9 00		    cmp #0
    84 49C1 F0 16		    beq end_vbi
    85 				;
    86 49C3 AD DE 49			lda sfx_effect
    87 49C6 30 0E			bmi lab2
    88 49C8 0A				asl @						; * 2
    89 49C9 A8				tay							;Y = 2,4,..,16	instrument number * 2 (0,2,4,..,126)
    90 49CA A2 03			ldx #3						;X = 3			channel (0..3 or 0..7 for stereo module)
    91 49CC A9 00			lda #0						;A = 12			note (0..60)
    92 49CE 20 0F 23			jsr RASTERMUSICTRACKER+15	;RMT_SFX start tone (It works only if FEAT_SFX is enabled !!!)
    93 				;
    94 49D1 A9 FF			lda #$ff
    95 49D3 8D DE 49			sta sfx_effect				;reinit value
    96 				;
    97 49D6			lab2
    98 49D6 20 03 23			jsr RASTERMUSICTRACKER+3	;1 play
    99
   100 49D9			end_vbi
   101 				;
   102 49D9 4C 62 E4			jmp $e462					;end vbi
   103 				;
   104 				;
   105 				;
   106 49DC 00 00		old_vbi dta 0,0
   107 49DE 00			sfx_effect dta 0				;sfx number variable
   108 49DF 00			track_to_play dta 0				;track to play
   109 49E0 00			music_plays dta 0				;1 if plays
   110 49E1 05			ntsc_counter dta 5
   111 49E2 B0 49		vbi_address dta .LO(vbi), .HI(vbi)
   112 49E4 00			vbi_counter dta 0
